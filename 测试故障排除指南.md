# 🛠️ XunDoc 测试故障排除指南

## ❌ 错误: "Connection peer refused channel request" / "IDE disconnection"

这是最常见的 Xcode 测试错误之一。以下是完整的解决方案。

---

## 🔍 问题原因

这个错误通常由以下原因引起：

1. **Xcode 缓存损坏** - 派生数据(DerivedData)问题
2. **模拟器状态异常** - 模拟器未正确启动或重置
3. **测试 Target 配置问题** - 测试方案配置不正确
4. **代码签名问题** - 开发证书或描述文件问题
5. **测试代码问题** - 测试代码在启动时立即崩溃

---

## ✅ 解决方案（按顺序尝试）

### 方案 1: 使用自动化脚本（推荐！）

我已经为你创建了一个自动化测试脚本，它会自动完成所有清理和启动步骤：

```bash
# 1. 给脚本添加执行权限
chmod +x /Users/plutoguo/Desktop/XunDoc/run_ui_tests.sh

# 2. 运行测试
/Users/plutoguo/Desktop/XunDoc/run_ui_tests.sh
```

这个脚本会：
- ✅ 清理派生数据
- ✅ 清理项目
- ✅ 启动模拟器
- ✅ 构建测试
- ✅ 运行测试

---

### 方案 2: 在 Xcode 中手动操作

#### 步骤 1: 清理派生数据

在 Xcode 中：
1. 点击菜单 **Product** → **Clean Build Folder** (或按 `⌘ + Shift + K`)
2. 关闭 Xcode
3. 在终端运行：
   ```bash
   rm -rf ~/Library/Developer/Xcode/DerivedData
   ```
4. 重新打开 Xcode

#### 步骤 2: 重置模拟器

1. 打开模拟器 (Xcode → Open Developer Tool → Simulator)
2. 在模拟器菜单中选择 **Device** → **Erase All Content and Settings**
3. 或在终端运行：
   ```bash
   xcrun simctl shutdown all
   xcrun simctl erase all
   ```

#### 步骤 3: 重新配置测试方案

1. 在 Xcode 中点击顶部方案选择器旁的 **Edit Scheme**
2. 选择左侧的 **Test**
3. 确保 `XunDocUITests` 已勾选
4. 点击 **Close**

#### 步骤 4: 选择正确的模拟器

1. 点击 Xcode 顶部的设备选择器
2. 选择一个具体的 iOS 模拟器（如 iPhone 15 Pro）
3. 不要选择 "Any iOS Simulator Device"

#### 步骤 5: 重新运行测试

1. 按 `⌘ + U` 运行测试
2. 或按 `⌘ + 6` 打开测试导航器，点击测试旁的 ▶️

---

### 方案 3: 命令行运行（详细版）

如果 Xcode UI 运行有问题，可以使用命令行：

```bash
# 1. 进入项目目录
cd /Users/plutoguo/Desktop/XunDoc

# 2. 清理
xcodebuild clean -project XunDoc.xcodeproj -scheme XunDoc

# 3. 查看可用模拟器
xcrun simctl list devices | grep iPhone

# 4. 选择一个模拟器ID（从上面的列表中复制）
SIMULATOR_ID="你的模拟器ID"

# 5. 启动模拟器
xcrun simctl boot $SIMULATOR_ID

# 6. 等待几秒
sleep 5

# 7. 运行测试
xcodebuild test \
  -project XunDoc.xcodeproj \
  -scheme XunDoc \
  -destination "platform=iOS Simulator,id=$SIMULATOR_ID" \
  -only-testing:XunDocUITests/XunDocComprehensiveStressTests
```

---

### 方案 4: 检查测试代码问题

如果上述方法都不行，可能是测试代码本身的问题。让我们先运行一个简单的测试：

#### 创建简单测试

在 `XunDocComprehensiveStressTests.swift` 最前面添加一个超级简单的测试：

```swift
/// 最基础的测试 - 用于验证测试框架是否工作
func test000_BasicTest() throws {
    print("🔥 [基础测试] 测试框架连接正常")
    XCTAssertTrue(true, "基础断言")
    print("✅ [通过] 测试框架工作正常\n")
}
```

然后只运行这个测试：
```bash
xcodebuild test \
  -project XunDoc.xcodeproj \
  -scheme XunDoc \
  -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
  -only-testing:XunDocUITests/XunDocComprehensiveStressTests/test000_BasicTest
```

---

### 方案 5: 检查权限和配置

#### 检查 Info.plist

确保你的应用 `Info.plist` 包含必要的权限：

```xml
<key>NSMicrophoneUsageDescription</key>
<string>用于录音功能</string>

<key>NSCameraUsageDescription</key>
<string>用于拍照功能</string>

<key>NSPhotoLibraryUsageDescription</key>
<string>用于保存和读取图片</string>
```

#### 检查测试 Target 设置

1. 在 Xcode 中选择项目文件
2. 选择 `XunDocUITests` target
3. 在 **Build Settings** 中搜索 "Test Host"
4. 确保 **Test Host** 设置为: `$(BUILT_PRODUCTS_DIR)/XunDoc.app/XunDoc`

---

### 方案 6: 完全重置 Xcode

如果以上都不行，执行完全重置：

```bash
# 1. 退出 Xcode
killall Xcode

# 2. 清理所有 Xcode 缓存
rm -rf ~/Library/Developer/Xcode/DerivedData
rm -rf ~/Library/Caches/com.apple.dt.Xcode

# 3. 重置模拟器
xcrun simctl shutdown all
xcrun simctl erase all

# 4. 重启 Mac（可选但推荐）
sudo reboot
```

---

## 🔍 诊断步骤

### 查看详细日志

在命令行运行时添加 `-verbose` 标志：

```bash
xcodebuild test \
  -project XunDoc.xcodeproj \
  -scheme XunDoc \
  -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
  -verbose
```

### 检查崩溃日志

```bash
# 查看模拟器崩溃日志
ls ~/Library/Logs/DiagnosticReports/ | grep XunDoc
```

### 检查测试是否被识别

```bash
# 列出所有测试
xcodebuild test \
  -project XunDoc.xcodeproj \
  -scheme XunDoc \
  -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
  -dry-run
```

---

## 📊 常见错误代码

| 错误信息 | 原因 | 解决方法 |
|---------|------|---------|
| Connection peer refused | 测试框架连接失败 | 清理派生数据 + 重启模拟器 |
| IDE disconnection | Xcode 失去连接 | 关闭其他 Xcode 窗口 |
| Test session exited | 应用崩溃 | 检查测试代码和应用代码 |
| Unable to boot device | 模拟器问题 | 重置模拟器 |
| Code signing error | 签名问题 | 检查开发证书 |

---

## 🎯 快速检查清单

在运行测试前，确保：

- [ ] Xcode 已完全关闭并重新打开
- [ ] 派生数据已清理
- [ ] 选择了具体的模拟器（不是"Any"）
- [ ] 模拟器已启动并完全加载
- [ ] 没有其他测试正在运行
- [ ] 磁盘空间充足（至少 5GB）
- [ ] 网络连接正常（如果测试需要）

---

## 💡 最佳实践

### 1. 始终先清理后构建
```bash
xcodebuild clean && xcodebuild build-for-testing
```

### 2. 使用特定的模拟器
不要使用 "Any iOS Simulator"，总是指定具体的设备。

### 3. 分步运行测试
先运行简单的测试，确保测试框架工作，再运行复杂的压力测试。

### 4. 定期清理
每天或每周清理一次派生数据：
```bash
rm -rf ~/Library/Developer/Xcode/DerivedData
```

---

## 🆘 仍然无法解决？

### 临时解决方案：运行单个测试

不要运行完整的测试套件，先运行单个简单的测试：

```bash
xcodebuild test \
  -project XunDoc.xcodeproj \
  -scheme XunDoc \
  -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
  -only-testing:XunDocUITests/XunDocComprehensiveStressTests/test001_AppLaunchStress
```

### 检查 Xcode 版本

```bash
xcodebuild -version
```

确保使用的是 Xcode 14+ 版本。

### 使用真机测试

如果模拟器一直有问题，可以尝试连接真实的 iOS 设备：

```bash
xcodebuild test \
  -project XunDoc.xcodeproj \
  -scheme XunDoc \
  -destination 'platform=iOS,name=你的iPhone名称'
```

---

## 📞 获取帮助

如果以上方法都不行：

1. **查看完整错误日志**
   ```bash
   xcodebuild test -verbose 2>&1 | tee test_log.txt
   ```

2. **检查系统日志**
   ```bash
   log show --predicate 'process == "Xcode"' --last 10m
   ```

3. **在 Apple 开发者论坛搜索错误信息**

---

## 🎉 成功运行的标志

如果测试成功启动，你会看到：

```
Testing started...
🔥 XunDoc 全面压力测试套件 - 开始执行
🔥 [压力测试-001] 应用启动压力测试
  第 1/5 次启动
    ✓ 启动成功
...
```

祝你测试顺利！🚀


