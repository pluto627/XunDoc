# éŸ³é¢‘æ’­æ”¾é”™è¯¯ä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°

é‡åˆ°éŸ³é¢‘æ’­æ”¾å¤±è´¥é”™è¯¯ï¼š
```
âŒ éŸ³é¢‘æ’­æ”¾å¤±è´¥: Error Domain=NSOSStatusErrorDomain Code=-39 "(null)"
âŒ éŸ³é¢‘æ•°æ®ä¸ºç©ºï¼Œæ— æ³•æ’­æ”¾
```

## é—®é¢˜æ ¹æœ¬åŸå›  âš ï¸

**éŸ³é¢‘æ•°æ®æ²¡æœ‰è¢«æ­£ç¡®ä¿å­˜ï¼**

åŸæ¥çš„å®ç°ä½¿ç”¨ `UserDefaults` ä¿å­˜æ•´ä¸ª `MedicalConversation` å¯¹è±¡ï¼ˆåŒ…æ‹¬éŸ³é¢‘æ•°æ®ï¼‰ï¼š

```swift
// æ—§çš„ä¿å­˜æ–¹å¼ - æœ‰é—®é¢˜ï¼
func saveConversations() {
    if let encoded = try? JSONEncoder().encode(conversations) {
        UserDefaults.standard.set(encoded, forKey: conversationsKey)  // âŒ éŸ³é¢‘æ•°æ®å¤ªå¤§
    }
}
```

**é—®é¢˜ï¼š**
1. âŒ `UserDefaults` åªé€‚åˆä¿å­˜å°æ•°æ®ï¼ˆ< 1MBï¼‰
2. âŒ éŸ³é¢‘æ–‡ä»¶é€šå¸¸å‡  MB ç”šè‡³å‡ å MB
3. âŒ ä¿å­˜æ—¶é™é»˜å¤±è´¥ï¼Œå¯¼è‡´éŸ³é¢‘æ•°æ®ä¸¢å¤±
4. âŒ ä¸‹æ¬¡åŠ è½½æ—¶ `audioData` ä¸º `nil`

## æ¬¡è¦åŸå› 

é”™è¯¯ä»£ç  `-39` è¿˜å¯èƒ½è¡¨ç¤ºï¼š
1. **éŸ³é¢‘æ•°æ®ä¸ºç©º** - `audioData` æ˜¯ `nil` æˆ–ç©ºçš„ `Data` å¯¹è±¡
2. **éŸ³é¢‘æ ¼å¼æ— æ•ˆ** - éŸ³é¢‘æ•°æ®æ ¼å¼ä¸å—æ”¯æŒæˆ–æ–‡ä»¶æŸå
3. **Preview æ•°æ®é—®é¢˜** - åœ¨ SwiftUI Preview ä¸­ä½¿ç”¨äº†æ— æ•ˆçš„æµ‹è¯•æ•°æ®

## è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒä¿®å¤ï¼šåˆ†ç¦»éŸ³é¢‘æ–‡ä»¶å­˜å‚¨ âœ…

**æ–°çš„å­˜å‚¨ç­–ç•¥ï¼š**
- ğŸ“ **éŸ³é¢‘æ•°æ®** â†’ ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿï¼ˆDocuments ç›®å½•ï¼‰
- ğŸ’¾ **å¯¹è¯å…ƒæ•°æ®** â†’ ä¿å­˜åˆ° UserDefaults

#### å®ç°ç»†èŠ‚

**1. åˆ›å»ºä¸“é—¨çš„éŸ³é¢‘æ–‡ä»¶å¤¹**

```swift
private let audioDirectory = "MedicalConversationAudios"

private func createAudioDirectoryIfNeeded() {
    let audioDir = getAudioDirectoryURL()
    if !FileManager.default.fileExists(atPath: audioDir.path) {
        try? FileManager.default.createDirectory(at: audioDir, withIntermediateDirectories: true)
        print("ğŸ“ åˆ›å»ºéŸ³é¢‘æ–‡ä»¶å¤¹: \(audioDir.path)")
    }
}

private func getAudioFileURL(for conversationId: UUID) -> URL {
    return getAudioDirectoryURL().appendingPathComponent("\(conversationId.uuidString).m4a")
}
```

**2. ä¿å­˜éŸ³é¢‘æ–‡ä»¶åˆ°æ–‡ä»¶ç³»ç»Ÿ**

```swift
private func saveAudioFile(data: Data, for conversationId: UUID) -> Bool {
    let fileURL = getAudioFileURL(for: conversationId)
    do {
        try data.write(to: fileURL)
        print("ğŸ’¾ éŸ³é¢‘æ–‡ä»¶å·²ä¿å­˜: \(fileURL.lastPathComponent), å¤§å°: \(data.count) å­—èŠ‚")
        return true
    } catch {
        print("âŒ éŸ³é¢‘æ–‡ä»¶ä¿å­˜å¤±è´¥: \(error)")
        return false
    }
}
```

**3. æ”¹è¿›çš„ä¿å­˜æµç¨‹**

```swift
func saveConversations() {
    // ç¬¬ä¸€æ­¥ï¼šä¿å­˜éŸ³é¢‘æ–‡ä»¶åˆ°æ–‡ä»¶ç³»ç»Ÿ
    for conversation in conversations {
        if let audioData = conversation.audioData, !audioData.isEmpty {
            _ = saveAudioFile(data: audioData, for: conversation.id)
        }
    }
    
    // ç¬¬äºŒæ­¥ï¼šåˆ›å»ºä¸å«éŸ³é¢‘æ•°æ®çš„å‰¯æœ¬
    var conversationsToSave = conversations
    for i in 0..<conversationsToSave.count {
        conversationsToSave[i].audioData = nil  // ä¸ä¿å­˜åˆ° UserDefaults
    }
    
    // ç¬¬ä¸‰æ­¥ï¼šä¿å­˜å…ƒæ•°æ®åˆ° UserDefaults
    if let encoded = try? JSONEncoder().encode(conversationsToSave) {
        UserDefaults.standard.set(encoded, forKey: conversationsKey)
        print("ğŸ’¾ ä¿å­˜äº† \(conversations.count) ä¸ªå¯¹è¯ï¼ˆéŸ³é¢‘æ–‡ä»¶å•ç‹¬å­˜å‚¨ï¼‰")
    }
}
```

**4. æ™ºèƒ½åŠ è½½éŸ³é¢‘æ•°æ®**

```swift
private func loadConversations() {
    if let data = UserDefaults.standard.data(forKey: conversationsKey),
       let decoded = try? JSONDecoder().decode([MedicalConversation].self, from: data) {
        conversations = decoded
        
        // ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½éŸ³é¢‘æ•°æ®
        for i in 0..<conversations.count {
            if let audioData = loadAudioFile(for: conversations[i].id) {
                conversations[i].audioData = audioData
            }
        }
        
        print("âœ… åŠ è½½äº† \(conversations.count) ä¸ªå¯¹è¯")
    }
}

func getConversations(for memberId: UUID) -> [MedicalConversation] {
    var memberConversations = conversations.filter { $0.memberId == memberId }
    
    // ç¡®ä¿æ¯ä¸ªå¯¹è¯éƒ½æœ‰éŸ³é¢‘æ•°æ®
    for i in 0..<memberConversations.count {
        if memberConversations[i].audioData == nil {
            memberConversations[i].audioData = loadAudioFile(for: memberConversations[i].id)
        }
    }
    
    return memberConversations.sorted { $0.date > $1.date }
}
```

**5. å®Œå–„çš„åˆ é™¤é€»è¾‘**

```swift
func deleteConversation(_ conversation: MedicalConversation) {
    // åˆ é™¤éŸ³é¢‘æ–‡ä»¶
    deleteAudioFile(for: conversation.id)
    
    // åˆ é™¤å¯¹è¯æ•°æ®
    conversations.removeAll { $0.id == conversation.id }
    saveConversations()
}
```

### 1. å¢å¼ºéŸ³é¢‘æ•°æ®éªŒè¯

åœ¨ `AudioPlayerManager` ä¸­æ·»åŠ äº†éŸ³é¢‘æ•°æ®éªŒè¯ï¼š

```swift
func loadAudio(_ audioData: Data) {
    // éªŒè¯éŸ³é¢‘æ•°æ®
    guard !audioData.isEmpty else {
        print("âŒ éŸ³é¢‘æ•°æ®ä¸ºç©ºï¼Œæ— æ³•åŠ è½½")
        return
    }
    
    print("ğŸµ éŸ³é¢‘æ•°æ®å¤§å°: \(audioData.count) å­—èŠ‚")
    
    do {
        audioPlayer = try AVAudioPlayer(data: audioData)
        // ... å…¶ä½™ä»£ç 
    } catch let error as NSError {
        print("âŒ éŸ³é¢‘åŠ è½½å¤±è´¥:")
        print("   é”™è¯¯åŸŸ: \(error.domain)")
        print("   é”™è¯¯ä»£ç : \(error.code)")
        
        if error.code == -39 {
            print("   æç¤º: éŸ³é¢‘æ•°æ®æ ¼å¼æ— æ•ˆæˆ–æ–‡ä»¶æŸå")
        }
    }
}
```

### 2. æ”¹è¿›é”™è¯¯æ—¥å¿—

ç°åœ¨é”™è¯¯æ—¥å¿—ä¼šæä¾›æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼š
- æ˜¾ç¤ºéŸ³é¢‘æ•°æ®å¤§å°
- æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯åŸŸå’Œä»£ç 
- é’ˆå¯¹ `-39` é”™è¯¯æä¾›ç‰¹å®šæç¤º

### 3. UI å±‚é¢çš„éªŒè¯

åœ¨ `ConversationView` ä¸­ï¼š

```swift
.onAppear {
    print("ğŸ“± ConversationView onAppear - å¯¹è¯: \(conversation.title)")
    if let audioData = conversation.audioData, !audioData.isEmpty {
        print("ğŸµ åŠ è½½éŸ³é¢‘æ•°æ®: \(audioData.count) å­—èŠ‚")
        audioPlayer.loadAudio(audioData)
    } else {
        print("âš ï¸ æ— éŸ³é¢‘æ•°æ®æˆ–éŸ³é¢‘æ•°æ®ä¸ºç©º")
    }
}
```

### 4. å‹å¥½çš„ç”¨æˆ·æç¤º

å½“å¯¹è¯æ²¡æœ‰éŸ³é¢‘æ•°æ®æ—¶ï¼Œæ˜¾ç¤ºå‹å¥½çš„æç¤ºä¿¡æ¯è€Œä¸æ˜¯ç©ºç™½çš„æ’­æ”¾æ§åˆ¶æ ï¼š

```swift
if conversation.audioData != nil && !conversation.audioData!.isEmpty {
    AudioControlBar(...)
} else {
    // æ— éŸ³é¢‘æç¤º
    HStack {
        Image(systemName: "info.circle.fill")
        Text("æ­¤å¯¹è¯æš‚æ— éŸ³é¢‘æ–‡ä»¶")
    }
    .background(Color.orange.opacity(0.1))
}
```

## ä½¿ç”¨å»ºè®®

### å½•åˆ¶éŸ³é¢‘æ—¶

ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„éŸ³é¢‘æ ¼å¼è®¾ç½®ï¼š

```swift
let settings = [
    AVFormatIDKey: Int(kAudioFormatMPEG4AAC),  // M4A æ ¼å¼
    AVSampleRateKey: 44100,                     // é‡‡æ ·ç‡
    AVNumberOfChannelsKey: 2,                   // åŒå£°é“
    AVEncoderAudioQualityKey: AVAudioQuality.high.rawValue
]
```

### ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶æ—¶

éªŒè¯æ–‡ä»¶æ•°æ®æœ‰æ•ˆæ€§ï¼š

```swift
if let url = audioFileURL {
    if let data = try? Data(contentsOf: url) {
        print("âœ… éŸ³é¢‘æ–‡ä»¶å¤§å°: \(data.count) å­—èŠ‚")
        // ä½¿ç”¨ data
    } else {
        print("âŒ æ— æ³•è¯»å–éŸ³é¢‘æ–‡ä»¶")
    }
}
```

### åœ¨ Preview ä¸­

ä¸è¦ä½¿ç”¨ç©ºçš„ `audioData`ï¼š

```swift
#Preview {
    ConversationView(conversation: MedicalConversation(
        // ... å…¶ä»–å‚æ•°
        audioData: nil,  // æ˜ç¡®è®¾ç½®ä¸º nil
        // ... å…¶ä»–å‚æ•°
    ))
}
```

## è°ƒè¯•æ­¥éª¤

å¦‚æœä»ç„¶é‡åˆ°é”™è¯¯ `-39`ï¼š

1. **æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—**
   - æŸ¥çœ‹éŸ³é¢‘æ•°æ®å¤§å°æ˜¯å¦ä¸º 0
   - æŸ¥çœ‹è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

2. **éªŒè¯éŸ³é¢‘æ–‡ä»¶**
   - ç¡®è®¤éŸ³é¢‘æ–‡ä»¶æ ¼å¼ï¼ˆæ”¯æŒ .m4a, .mp3, .wav ç­‰ï¼‰
   - å°è¯•åœ¨å…¶ä»–åº”ç”¨ä¸­æ’­æ”¾è¯¥éŸ³é¢‘æ–‡ä»¶

3. **æ£€æŸ¥å½•éŸ³è®¾ç½®**
   - ç¡®è®¤ `AVAudioSession` é…ç½®æ­£ç¡®
   - ç¡®è®¤æœ‰å½•éŸ³æƒé™

4. **æµ‹è¯•éŸ³é¢‘æ•°æ®**
   ```swift
   if let audioData = conversation.audioData {
       print("éŸ³é¢‘æ•°æ®å¤§å°: \(audioData.count) å­—èŠ‚")
       print("éŸ³é¢‘æ•°æ®å‰ 10 å­—èŠ‚: \(audioData.prefix(10).map { String(format: "%02x", $0) }.joined())")
   }
   ```

## ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨

### æ ¸å¿ƒä¿®å¤
- âœ… `AudioTranscriptionManager.swift` - **é‡æ„éŸ³é¢‘å­˜å‚¨é€»è¾‘**
  - æ·»åŠ æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨
  - åˆ†ç¦»éŸ³é¢‘æ•°æ®å’Œå…ƒæ•°æ®
  - æ™ºèƒ½åŠ è½½æœºåˆ¶
  - å®Œå–„åˆ é™¤é€»è¾‘

### å¢å¼ºåŠŸèƒ½
- âœ… `AudioPlayerManager.swift` - æ·»åŠ æ•°æ®éªŒè¯å’Œè¯¦ç»†é”™è¯¯æ—¥å¿—
- âœ… `ConversationView.swift` - æ·»åŠ éŸ³é¢‘æ•°æ®æ£€æŸ¥å’Œå‹å¥½æç¤º

## å­˜å‚¨ç»“æ„

```
Documents/
  â””â”€â”€ MedicalConversationAudios/
      â”œâ”€â”€ <UUID-1>.m4a    (éŸ³é¢‘æ–‡ä»¶ 1)
      â”œâ”€â”€ <UUID-2>.m4a    (éŸ³é¢‘æ–‡ä»¶ 2)
      â””â”€â”€ <UUID-3>.m4a    (éŸ³é¢‘æ–‡ä»¶ 3)

UserDefaults:
  â””â”€â”€ medical_conversations (å¯¹è¯å…ƒæ•°æ®ï¼Œä¸å«éŸ³é¢‘æ•°æ®)
```

## ä½¿ç”¨åœºæ™¯æ—¥å¿—

### åœºæ™¯ 1: å½•åˆ¶å¹¶ä¿å­˜æ–°å¯¹è¯

```
ğŸ“ åˆ›å»ºéŸ³é¢‘æ–‡ä»¶å¤¹: /Documents/MedicalConversationAudios
ğŸ™ï¸ å¯¹è¯ä¿å­˜æˆåŠŸ:
  æ ‡é¢˜: å†…ç§‘é—¨è¯Š
  æ—¶é•¿: 180ç§’
ğŸ’¾ éŸ³é¢‘æ–‡ä»¶å·²ä¿å­˜: <UUID>.m4a, å¤§å°: 2456789 å­—èŠ‚
ğŸ’¾ ä¿å­˜äº† 1 ä¸ªå¯¹è¯ï¼ˆéŸ³é¢‘æ–‡ä»¶å•ç‹¬å­˜å‚¨ï¼‰
```

### åœºæ™¯ 2: åŠ è½½å¯¹è¯åˆ—è¡¨

```
âœ… åŠ è½½äº† 5 ä¸ªå¯¹è¯
âœ… åŠ è½½éŸ³é¢‘æ–‡ä»¶: <UUID-1>.m4a, å¤§å°: 2456789 å­—èŠ‚
âœ… åŠ è½½éŸ³é¢‘æ–‡ä»¶: <UUID-2>.m4a, å¤§å°: 3123456 å­—èŠ‚
...
```

### åœºæ™¯ 3: æ‰“å¼€å¯¹è¯è¯¦æƒ…

```
ğŸ“± ConversationView onAppear - å¯¹è¯: å†…ç§‘é—¨è¯Š
ğŸµ åŠ è½½éŸ³é¢‘æ•°æ®: 2456789 å­—èŠ‚
ğŸµ éŸ³é¢‘æ•°æ®å¤§å°: 2456789 å­—èŠ‚
âœ… éŸ³é¢‘åŠ è½½æˆåŠŸï¼Œæ—¶é•¿: 180.0ç§’
```

### åœºæ™¯ 4: åˆ é™¤å¯¹è¯

```
ğŸ—‘ï¸ åˆ é™¤éŸ³é¢‘æ–‡ä»¶: <UUID>.m4a
ğŸ’¾ ä¿å­˜äº† 4 ä¸ªå¯¹è¯ï¼ˆéŸ³é¢‘æ–‡ä»¶å•ç‹¬å­˜å‚¨ï¼‰
```

## æµ‹è¯•ç¡®è®¤

- âœ… ç¼–è¯‘æ— é”™è¯¯
- âœ… éŸ³é¢‘æ–‡ä»¶æ­£ç¡®ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿ
- âœ… éŸ³é¢‘æ•°æ®æ­£ç¡®åŠ è½½
- âœ… å¯¹è¯åˆ é™¤æ—¶åŒæ­¥åˆ é™¤éŸ³é¢‘æ–‡ä»¶
- âœ… ç©ºéŸ³é¢‘æ•°æ®ä¸ä¼šè§¦å‘å´©æºƒ
- âœ… æ˜¾ç¤ºå‹å¥½çš„ç”¨æˆ·æç¤º
- âœ… è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
- âœ… æ”¯æŒå¤§éŸ³é¢‘æ–‡ä»¶ï¼ˆ> 1MBï¼‰

## è¿ç§»è¯´æ˜

**å¯¹äºå·²æœ‰çš„å¯¹è¯æ•°æ®ï¼š**

å¦‚æœæ‚¨ä¹‹å‰å·²ç»åˆ›å»ºäº†ä¸€äº›å¯¹è¯ï¼Œä½†éŸ³é¢‘æ•°æ®ä¸¢å¤±äº†ï¼Œéœ€è¦ï¼š
1. é‡æ–°å½•åˆ¶æˆ–ä¸Šä¼ éŸ³é¢‘
2. æˆ–è€…ä½¿ç”¨å¼€å‘å·¥å…·æ¸…é™¤æ—§æ•°æ®ï¼š

```swift
// æ¸…é™¤æ—§æ•°æ®ï¼ˆä»…å¼€å‘æµ‹è¯•æ—¶ï¼‰
UserDefaults.standard.removeObject(forKey: "medical_conversations")
```

**ç°åœ¨å¼€å§‹ï¼Œæ‰€æœ‰æ–°åˆ›å»ºçš„å¯¹è¯éƒ½ä¼šæ­£ç¡®ä¿å­˜éŸ³é¢‘æ•°æ®ï¼** âœ…

---

**æ—¥æœŸ**: 2025-10-28  
**çŠ¶æ€**: å·²å®Œæˆ âœ…  
**å½±å“**: ğŸ”´ é‡è¦ä¿®å¤ - è§£å†³éŸ³é¢‘æ•°æ®ä¸¢å¤±é—®é¢˜

