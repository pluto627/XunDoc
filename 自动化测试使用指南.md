# XunDoc iOS 自动化测试使用指南

## 📋 概述

本项目包含完整的iOS UI自动化测试脚本，基于Apple官方的XCUITest框架开发，可以自动测试应用的主要功能。

---

## 🎯 测试覆盖范围

### ✅ 已实现的自动化测试 (10个测试用例)

| 测试编号 | 测试名称 | 测试内容 | 优先级 |
|---------|---------|---------|-------|
| TC-AUTO-001 | 应用启动测试 | 验证应用正常启动和主页加载 | P0 |
| TC-AUTO-002 | 底部导航测试 | 测试4个Tab页面切换 | P0 |
| TC-AUTO-003 | 创建记录测试 | 自动创建就诊记录 | P0 |
| TC-AUTO-004 | 搜索功能测试 | 测试记录搜索功能 | P1 |
| TC-AUTO-005 | 查看详情测试 | 测试病历详情页面 | P1 |
| TC-AUTO-006 | 添加用药测试 | 自动添加用药提醒 | P0 |
| TC-AUTO-007 | 完成用药测试 | 测试标记用药完成 | P1 |
| TC-AUTO-008 | 个人页面测试 | 测试个人页面功能入口 | P1 |
| TC-AUTO-009 | 性能测试 | 测试页面切换性能 | P1 |
| TC-AUTO-010 | 稳定性测试 | 快速操作压力测试 | P1 |

---

## 🚀 快速开始

### 方法一：在Xcode中运行测试

#### 1. 打开项目
```bash
cd /Users/plutoguo/Desktop/XunDoc
open XunDoc.xcodeproj
```

#### 2. 运行单个测试
1. 在Xcode中按 `Cmd + 6` 打开测试导航器
2. 找到 `XunDocUITests` > `XunDocAutomatedTests`
3. 点击任一测试方法旁边的 ▶️ 按钮运行

#### 3. 运行所有测试
1. 选择测试类 `XunDocAutomatedTests`
2. 点击类名旁边的 ▶️ 按钮
3. 或使用快捷键 `Cmd + U` 运行所有测试

#### 4. 运行完整测试套件
运行 `testCompleteTestSuite()` 方法，将按顺序执行所有10个测试用例

---

### 方法二：使用命令行运行测试

#### 运行所有UI测试
```bash
cd /Users/plutoguo/Desktop/XunDoc

# 在模拟器上运行
xcodebuild test \
  -project XunDoc.xcodeproj \
  -scheme XunDoc \
  -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.0' \
  -only-testing:XunDocUITests
```

#### 运行特定测试
```bash
# 只运行应用启动测试
xcodebuild test \
  -project XunDoc.xcodeproj \
  -scheme XunDoc \
  -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.0' \
  -only-testing:XunDocUITests/XunDocAutomatedTests/test001_AppLaunch
```

#### 生成测试报告
```bash
# 运行测试并生成HTML报告
xcodebuild test \
  -project XunDoc.xcodeproj \
  -scheme XunDoc \
  -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.0' \
  -only-testing:XunDocUITests \
  -resultBundlePath TestResults.xcresult

# 查看结果
open TestResults.xcresult
```

---

### 方法三：使用Fastlane自动化（推荐）

#### 1. 安装Fastlane
```bash
# 使用Homebrew安装
brew install fastlane

# 或使用RubyGems
sudo gem install fastlane
```

#### 2. 创建Fastfile
在项目根目录创建 `fastlane/Fastfile`:

```ruby
# fastlane/Fastfile

default_platform(:ios)

platform :ios do
  
  # 运行UI自动化测试
  desc "运行UI自动化测试"
  lane :ui_test do
    run_tests(
      scheme: "XunDoc",
      devices: ["iPhone 15 Pro", "iPhone SE (3rd generation)"],
      clean: true,
      code_coverage: true,
      output_directory: "./test_output",
      output_types: "html,junit"
    )
  end
  
  # 快速测试（仅核心功能）
  desc "快速测试核心功能"
  lane :quick_test do
    run_tests(
      scheme: "XunDoc",
      devices: ["iPhone 15 Pro"],
      only_testing: [
        "XunDocUITests/XunDocAutomatedTests/test001_AppLaunch",
        "XunDocUITests/XunDocAutomatedTests/test002_TabBarNavigation",
        "XunDocUITests/XunDocAutomatedTests/test003_CreateHealthRecord"
      ]
    )
  end
  
  # 完整测试套件
  desc "运行完整测试套件"
  lane :full_test do
    run_tests(
      scheme: "XunDoc",
      devices: ["iPhone 15 Pro", "iPhone 14", "iPhone SE (3rd generation)"],
      clean: true,
      code_coverage: true,
      result_bundle: true,
      output_directory: "./test_output",
      output_types: "html,junit,json"
    )
    
    # 生成测试报告
    sh("echo '测试完成！查看报告: ./test_output/report.html'")
  end
  
  # 夜间回归测试
  desc "夜间回归测试"
  lane :nightly do
    # 清理
    clean_build_artifacts
    
    # 运行测试
    full_test
    
    # 发送通知（可选）
    notification(
      title: "XunDoc 测试完成",
      message: "夜间回归测试已完成，请查看报告"
    )
  end
end
```

#### 3. 运行Fastlane测试
```bash
# 运行UI测试
fastlane ui_test

# 快速测试
fastlane quick_test

# 完整测试
fastlane full_test

# 夜间测试
fastlane nightly
```

---

## 📊 测试报告

### 查看测试结果

#### 1. Xcode中查看
- 测试完成后，点击 Xcode 右侧的 "Report Navigator" (Cmd + 9)
- 选择最新的测试运行记录
- 查看详细的测试结果、截图和日志

#### 2. 命令行查看
```bash
# 查看.xcresult文件
xcrun xcresulttool get --path TestResults.xcresult
```

#### 3. HTML报告
使用Fastlane运行测试会自动生成HTML报告：
```bash
open ./test_output/report.html
```

### 测试报告包含内容
- ✅ 通过的测试数量
- ❌ 失败的测试数量
- ⏱️ 每个测试的执行时间
- 📸 失败时的自动截图
- 📝 详细的测试日志
- 📈 测试通过率统计

---

## 🔧 配置和定制

### 1. 修改测试设备
编辑测试代码或Fastfile中的设备列表：
```swift
// 支持的设备
- iPhone SE (3rd generation)
- iPhone 14
- iPhone 15 Pro
- iPhone 15 Pro Max
- iPad Air (5th generation)
```

### 2. 添加新的测试用例
在 `XunDocAutomatedTests.swift` 中添加新方法：
```swift
/// TC-AUTO-011: 你的测试描述
func test011_YourTestName() throws {
    print("📱 [测试] 测试描述")
    
    // 1. 准备测试环境
    navigateToHome()
    
    // 2. 执行测试操作
    let button = app.buttons["按钮标识"]
    XCTAssertTrue(button.exists, "按钮应该存在")
    button.tap()
    
    // 3. 验证结果
    let result = app.staticTexts["预期结果"]
    XCTAssertTrue(result.exists, "应该显示预期结果")
    
    print("✅ [通过] 测试通过")
}
```

### 3. 设置测试超时时间
```swift
// 在 setUpWithError() 中设置
executionTimeAllowance = 300 // 5分钟
```

### 4. 启用/禁用测试
```swift
// 临时跳过某个测试
func test_SkipThisTest() throws {
    throw XCTSkip("暂时跳过此测试")
}
```

---

## 🎬 测试最佳实践

### 1. 测试前准备
```swift
// 在每个测试前重置应用状态
override func setUpWithError() throws {
    continueAfterFailure = false
    
    app = XCUIApplication()
    app.launchArguments = ["UI-Testing"]
    app.launch()
    
    // 等待启动完成
    sleep(3)
}
```

### 2. 使用Accessibility Identifier
在代码中设置：
```swift
// SwiftUI
Text("登录")
    .accessibilityIdentifier("loginButton")

// UIKit
button.accessibilityIdentifier = "loginButton"
```

在测试中使用：
```swift
let loginButton = app.buttons["loginButton"]
loginButton.tap()
```

### 3. 等待元素出现
```swift
// 等待最多5秒
let element = app.buttons["提交"]
let exists = element.waitForExistence(timeout: 5)
XCTAssertTrue(exists, "提交按钮应该在5秒内出现")
```

### 4. 处理异步操作
```swift
// 等待网络请求完成
let expectation = XCTestExpectation(description: "数据加载")
DispatchQueue.main.asyncAfter(deadline: .now() + 2) {
    expectation.fulfill()
}
wait(for: [expectation], timeout: 5)
```

### 5. 截图保存
```swift
// 在关键步骤截图
private func takeScreenshot(name: String) {
    let screenshot = app.screenshot()
    let attachment = XCTAttachment(screenshot: screenshot)
    attachment.name = name
    attachment.lifetime = .keepAlways
    add(attachment)
}

// 使用
takeScreenshot(name: "登录成功页面")
```

---

## 🐛 常见问题

### Q1: 找不到元素
**解决方法**：
```swift
// 1. 检查元素类型
app.buttons["按钮"]
app.staticTexts["文本"]
app.textFields["输入框"]

// 2. 使用模糊匹配
let button = app.buttons.matching(NSPredicate(format: "label CONTAINS '登录'")).firstMatch

// 3. 打印所有元素
print(app.debugDescription)
```

### Q2: 测试运行缓慢
**解决方法**：
```swift
// 1. 减少sleep时间
sleep(1) // 改为更短的等待

// 2. 使用waitForExistence替代sleep
element.waitForExistence(timeout: 2)

// 3. 并行运行测试
// 在测试方案中启用 "Parallelize" 选项
```

### Q3: 测试不稳定（Flaky Tests）
**解决方法**：
```swift
// 1. 增加等待时间
element.waitForExistence(timeout: 5)

// 2. 重试机制
func tapWithRetry(_ element: XCUIElement, retries: Int = 3) {
    for i in 0..<retries {
        if element.exists && element.isHittable {
            element.tap()
            return
        }
        sleep(1)
    }
    XCTFail("无法点击元素")
}

// 3. 检查元素是否可交互
if element.exists && element.isHittable {
    element.tap()
}
```

### Q4: 模拟器不响应
**解决方法**：
```bash
# 重置所有模拟器
xcrun simctl shutdown all
xcrun simctl erase all

# 重启模拟器服务
sudo killall -9 com.apple.CoreSimulator.CoreSimulatorService
```

---

## 📅 CI/CD集成

### GitHub Actions
创建 `.github/workflows/ui-tests.yml`:
```yaml
name: UI Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v3
      
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.0.app
      
      - name: Run UI Tests
        run: |
          xcodebuild test \
            -project XunDoc.xcodeproj \
            -scheme XunDoc \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.0' \
            -only-testing:XunDocUITests
      
      - name: Upload Test Results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results
          path: TestResults.xcresult
```

---

## 📈 测试指标

### 建议的测试覆盖率目标
- **核心功能**: 100% (启动、导航、创建记录、添加用药)
- **主要功能**: 80% (搜索、详情、编辑、删除)
- **辅助功能**: 60% (统计、帮助、关于)

### 性能基准
- 应用启动时间: < 3秒
- 页面切换: < 0.5秒
- 列表滚动: 60 FPS
- 网络请求: < 2秒

---

## 📞 支持

如有问题，请联系：
- 📧 Email: support@xundoc.com
- 📝 Issues: 在项目中创建Issue

---

**最后更新**: 2025-10-29  
**版本**: v1.0.0


