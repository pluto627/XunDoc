# Fastfile - XunDoc è‡ªåŠ¨åŒ–æµ‹è¯•é…ç½®
# ä½¿ç”¨æ–¹æ³•: fastlane [lane_name]

default_platform(:ios)

platform :ios do
  
  # ======================================================
  # æµ‹è¯•ç›¸å…³ Lanes
  # ======================================================
  
  desc "ğŸš€ è¿è¡ŒUIè‡ªåŠ¨åŒ–æµ‹è¯•"
  desc "åœ¨iPhone 15 Proæ¨¡æ‹Ÿå™¨ä¸Šè¿è¡Œæ‰€æœ‰UIæµ‹è¯•"
  lane :ui_test do
    UI.message("å¼€å§‹è¿è¡ŒUIè‡ªåŠ¨åŒ–æµ‹è¯•...")
    
    run_tests(
      scheme: "XunDoc",
      devices: ["iPhone 15 Pro"],
      clean: true,
      code_coverage: true,
      output_directory: "./test_output",
      output_types: "html,junit",
      xcargs: "-only-testing:XunDocUITests"
    )
    
    UI.success("âœ… UIæµ‹è¯•å®Œæˆï¼")
    UI.message("ğŸ“Š æŸ¥çœ‹æŠ¥å‘Š: ./test_output/report.html")
  end
  
  desc "âš¡ å¿«é€Ÿæµ‹è¯• - ä»…æ ¸å¿ƒåŠŸèƒ½"
  desc "è¿è¡Œå¯åŠ¨ã€å¯¼èˆªã€åˆ›å»ºè®°å½•ä¸‰ä¸ªæ ¸å¿ƒæµ‹è¯•"
  lane :quick_test do
    UI.message("å¼€å§‹å¿«é€Ÿæµ‹è¯•...")
    
    run_tests(
      scheme: "XunDoc",
      devices: ["iPhone 15 Pro"],
      clean: false,
      only_testing: [
        "XunDocUITests/XunDocAutomatedTests/test001_AppLaunch",
        "XunDocUITests/XunDocAutomatedTests/test002_TabBarNavigation",
        "XunDocUITests/XunDocAutomatedTests/test003_CreateHealthRecord"
      ]
    )
    
    UI.success("âœ… å¿«é€Ÿæµ‹è¯•å®Œæˆï¼")
  end
  
  desc "ğŸ”¬ å®Œæ•´æµ‹è¯•å¥—ä»¶"
  desc "åœ¨å¤šä¸ªè®¾å¤‡ä¸Šè¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶"
  lane :full_test do
    UI.message("å¼€å§‹å®Œæ•´æµ‹è¯•å¥—ä»¶...")
    
    # æ¸…ç†ä¹‹å‰çš„æµ‹è¯•è¾“å‡º
    sh("rm -rf ../test_output")
    sh("mkdir -p ../test_output")
    
    # åœ¨å¤šä¸ªè®¾å¤‡ä¸Šè¿è¡Œ
    devices = [
      "iPhone 15 Pro",
      "iPhone 14",
      "iPhone SE (3rd generation)"
    ]
    
    devices.each do |device|
      UI.message("ğŸ“± åœ¨ #{device} ä¸Šè¿è¡Œæµ‹è¯•...")
      
      run_tests(
        scheme: "XunDoc",
        devices: [device],
        clean: false,
        code_coverage: true,
        result_bundle: true,
        output_directory: "./test_output/#{device.gsub(' ', '_')}",
        output_types: "html,junit,json",
        xcargs: "-only-testing:XunDocUITests"
      )
    end
    
    # ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
    generate_summary_report
    
    UI.success("âœ… å®Œæ•´æµ‹è¯•å¥—ä»¶å®Œæˆï¼")
    UI.message("ğŸ“Š æŸ¥çœ‹æ±‡æ€»æŠ¥å‘Š: ./test_output/summary.html")
  end
  
  desc "ğŸŒ™ å¤œé—´å›å½’æµ‹è¯•"
  desc "å®Œæ•´çš„å¤œé—´è‡ªåŠ¨åŒ–æµ‹è¯•ï¼ŒåŒ…å«æ¸…ç†å’ŒæŠ¥å‘Š"
  lane :nightly do
    UI.header("å¼€å§‹å¤œé—´å›å½’æµ‹è¯•")
    
    begin
      # 1. æ¸…ç†æ„å»ºäº§ç‰©
      UI.message("ğŸ§¹ æ¸…ç†æ„å»ºäº§ç‰©...")
      clean_build_artifacts
      
      # 2. è¿è¡Œå®Œæ•´æµ‹è¯•
      full_test
      
      # 3. ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
      UI.message("ğŸ“ˆ ç”Ÿæˆä»£ç è¦†ç›–ç‡æŠ¥å‘Š...")
      xcov(
        scheme: "XunDoc",
        output_directory: "./test_output/coverage",
        minimum_coverage_percentage: 70.0
      )
      
      # 4. å‘é€é€šçŸ¥
      notification(
        title: "âœ… XunDoc å¤œé—´æµ‹è¯•å®Œæˆ",
        message: "æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š"
      )
      
      UI.success("âœ… å¤œé—´æµ‹è¯•å…¨éƒ¨å®Œæˆï¼")
      
    rescue => ex
      # æµ‹è¯•å¤±è´¥æ—¶çš„å¤„ç†
      UI.error("âŒ å¤œé—´æµ‹è¯•å¤±è´¥: #{ex.message}")
      
      notification(
        title: "âŒ XunDoc å¤œé—´æµ‹è¯•å¤±è´¥",
        message: "æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
      )
      
      raise ex
    end
  end
  
  desc "ğŸ¯ å•å…ƒæµ‹è¯•"
  desc "è¿è¡Œå•å…ƒæµ‹è¯•ï¼ˆéUIæµ‹è¯•ï¼‰"
  lane :unit_test do
    UI.message("å¼€å§‹è¿è¡Œå•å…ƒæµ‹è¯•...")
    
    run_tests(
      scheme: "XunDoc",
      devices: ["iPhone 15 Pro"],
      clean: true,
      code_coverage: true,
      xcargs: "-only-testing:XunDocTests"
    )
    
    UI.success("âœ… å•å…ƒæµ‹è¯•å®Œæˆï¼")
  end
  
  desc "ğŸ“Š ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š"
  desc "ä».xcresultæ–‡ä»¶ç”ŸæˆHTMLæµ‹è¯•æŠ¥å‘Š"
  lane :generate_report do |options|
    xcresult_path = options[:xcresult_path] || "./test_output/XunDoc.xcresult"
    
    UI.message("ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š...")
    
    sh("xcrun xcresulttool get --format json --path #{xcresult_path} > ../test_output/results.json")
    
    UI.success("æŠ¥å‘Šç”Ÿæˆå®Œæˆï¼")
  end
  
  # ======================================================
  # è¾…åŠ©æ–¹æ³•
  # ======================================================
  
  desc "ç”Ÿæˆæµ‹è¯•æ±‡æ€»æŠ¥å‘Š"
  private_lane :generate_summary_report do
    UI.message("ç”Ÿæˆæµ‹è¯•æ±‡æ€»æŠ¥å‘Š...")
    
    # åˆ›å»ºç®€å•çš„HTMLæ±‡æ€»æŠ¥å‘Š
    html_content = <<-HTML
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>XunDoc æµ‹è¯•æŠ¥å‘Š</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #333; }
        .summary {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .device {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #007AFF;
        }
        .success { color: #34C759; }
        .failure { color: #FF3B30; }
        .timestamp { color: #999; font-size: 0.9em; }
    </style>
</head>
<body>
    <h1>ğŸ“Š XunDoc è‡ªåŠ¨åŒ–æµ‹è¯•æŠ¥å‘Š</h1>
    <div class="summary">
        <h2>æµ‹è¯•æ¦‚è§ˆ</h2>
        <p>æµ‹è¯•æ—¶é—´: #{Time.now.strftime('%Y-%m-%d %H:%M:%S')}</p>
        <p>æµ‹è¯•è®¾å¤‡: iPhone 15 Pro, iPhone 14, iPhone SE (3rd generation)</p>
        <p>æµ‹è¯•ç”¨ä¾‹æ•°: 10ä¸ª</p>
    </div>
    
    <div class="device">
        <h3>ğŸ“± iPhone 15 Pro</h3>
        <p>æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š: <a href="iPhone_15_Pro/report.html">report.html</a></p>
    </div>
    
    <div class="device">
        <h3>ğŸ“± iPhone 14</h3>
        <p>æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š: <a href="iPhone_14/report.html">report.html</a></p>
    </div>
    
    <div class="device">
        <h3>ğŸ“± iPhone SE (3rd generation)</h3>
        <p>æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š: <a href="iPhone_SE_(3rd_generation)/report.html">report.html</a></p>
    </div>
</body>
</html>
    HTML
    
    File.write("./test_output/summary.html", html_content)
  end
  
  # ======================================================
  # æ„å»ºç›¸å…³ Lanes
  # ======================================================
  
  desc "ğŸ—ï¸ æ„å»ºåº”ç”¨"
  lane :build do
    build_app(
      scheme: "XunDoc",
      configuration: "Debug",
      skip_archive: true,
      skip_codesigning: true
    )
  end
  
  desc "ğŸ§¹ æ¸…ç†æ„å»ºäº§ç‰©"
  lane :clean do
    clean_build_artifacts
    sh("rm -rf ../DerivedData")
    sh("rm -rf ../test_output")
    UI.success("âœ… æ¸…ç†å®Œæˆï¼")
  end
  
  # ======================================================
  # æˆªå›¾å’ŒApp Store
  # ======================================================
  
  desc "ğŸ“¸ ç”ŸæˆApp Storeæˆªå›¾"
  lane :screenshots do
    capture_screenshots(
      scheme: "XunDoc",
      devices: [
        "iPhone 15 Pro Max",
        "iPhone 15 Pro",
        "iPhone 8 Plus",
        "iPad Pro (12.9-inch) (6th generation)"
      ],
      languages: ["zh-Hans", "en-US"],
      clear_previous_screenshots: true,
      output_directory: "./screenshots"
    )
    
    UI.success("âœ… æˆªå›¾ç”Ÿæˆå®Œæˆï¼")
  end
  
  # ======================================================
  # ç‰ˆæœ¬ç®¡ç†
  # ======================================================
  
  desc "ğŸ”¢ ç‰ˆæœ¬å·é€’å¢"
  lane :bump_version do |options|
    version_type = options[:type] || "patch" # major, minor, patch
    
    increment_version_number(
      bump_type: version_type
    )
    
    increment_build_number
    
    UI.success("âœ… ç‰ˆæœ¬å·å·²æ›´æ–°ï¼")
  end
  
  # ======================================================
  # é”™è¯¯å¤„ç†
  # ======================================================
  
  error do |lane, exception|
    UI.error("âŒ Lane '#{lane}' æ‰§è¡Œå¤±è´¥")
    UI.error("é”™è¯¯ä¿¡æ¯: #{exception.message}")
    
    # å‘é€å¤±è´¥é€šçŸ¥
    notification(
      title: "âŒ XunDoc æ„å»ºå¤±è´¥",
      message: "Lane: #{lane}\né”™è¯¯: #{exception.message}"
    )
  end
  
end

# ======================================================
# è‡ªå®šä¹‰Actions (å¯é€‰)
# ======================================================

# ç¤ºä¾‹ï¼šè‡ªå®šä¹‰æµ‹è¯•å‰çš„å‡†å¤‡å·¥ä½œ
before_all do |lane, options|
  UI.message("å‡†å¤‡æ‰§è¡Œ lane: #{lane}")
  
  # ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„Xcodeç‰ˆæœ¬
  # xcversion(version: "15.0")
end

# ç¤ºä¾‹ï¼šæµ‹è¯•å®Œæˆåçš„æ¸…ç†å·¥ä½œ
after_all do |lane, options|
  UI.success("Lane '#{lane}' æ‰§è¡Œå®Œæˆï¼")
end


