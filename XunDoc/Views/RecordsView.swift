//
//  RecordsView.swift
//  XunDoc
//
//  Created by pluto guo on 9/15/25.
//

import SwiftUI
import Vision

struct RecordsView: View {
    @EnvironmentObject var healthDataManager: HealthDataManager
    @State private var searchText = ""
    @State private var showingAddCase = false
    
    // üîç Ê∑ªÂä†ÊêúÁ¥¢ËøáÊª§ÂäüËÉΩ
    private var unarchivedRecords: [HealthRecord] {
        let records = healthDataManager.getUnarchivedRecords()
        print("üîç RecordsView: Êú™ÂΩíÊ°£ËÆ∞ÂΩïÊï∞ = \(records.count)")
        
        // Â¶ÇÊûúÊúâÊêúÁ¥¢ÊñáÊú¨ÔºåËøõË°åËøáÊª§
        if !searchText.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty {
            let filtered = records.filter { record in
                searchRecord(record, with: searchText)
            }
            print("üîç ÊêúÁ¥¢ '\(searchText)': ÊâæÂà∞ \(filtered.count) Êù°Êú™ÂΩíÊ°£ËÆ∞ÂΩï")
            return filtered
        }
        
        return records
    }
    
    private var archivedRecords: [HealthRecord] {
        let records = healthDataManager.getArchivedRecords()
        print("üîç RecordsView: Â∑≤ÂΩíÊ°£ËÆ∞ÂΩïÊï∞ = \(records.count)")
        
        // Â¶ÇÊûúÊúâÊêúÁ¥¢ÊñáÊú¨ÔºåËøõË°åËøáÊª§
        if !searchText.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty {
            let filtered = records.filter { record in
                searchRecord(record, with: searchText)
            }
            print("üîç ÊêúÁ¥¢ '\(searchText)': ÊâæÂà∞ \(filtered.count) Êù°Â∑≤ÂΩíÊ°£ËÆ∞ÂΩï")
            return filtered
        }
        
        return records
    }
    
    // üîç ÊêúÁ¥¢ËÆ∞ÂΩïÁöÑËæÖÂä©ÂáΩÊï∞
    private func searchRecord(_ record: HealthRecord, with searchText: String) -> Bool {
        let text = searchText.lowercased()
        
        // ÊêúÁ¥¢ÂåªÈô¢ÂêçÁß∞
        if record.hospitalName.lowercased().contains(text) {
            return true
        }
        
        // ÊêúÁ¥¢ÁßëÂÆ§
        if record.department.lowercased().contains(text) {
            return true
        }
        
        // ÊêúÁ¥¢Êó•Êúü
        let dateFormatter = DateFormatter()
        dateFormatter.dateFormat = "yyyy-MM-dd"
        let dateString = dateFormatter.string(from: record.date)
        if dateString.contains(text) {
            return true
        }
        
        // ÊêúÁ¥¢ÁóáÁä∂
        if record.symptoms.lowercased().contains(text) {
            return true
        }
        
        // ÊêúÁ¥¢ËØäÊñ≠
        if let diagnosis = record.diagnosis, diagnosis.lowercased().contains(text) {
            return true
        }
        
        // ÊêúÁ¥¢Ê≤ªÁñóÊñπÊ°à
        if let treatment = record.treatment, treatment.lowercased().contains(text) {
            return true
        }
        
        return false
    }
    
    var body: some View {
        NavigationView {
            ScrollView(showsIndicators: false) {
                VStack(spacing: 0) {
                    // Header
                    RecordsHeader(showingAddCase: $showingAddCase)
                        .padding(.horizontal, 20)
                        .padding(.top, 24)
                        .padding(.bottom, 24)
                    
                    // Search Bar
                    SearchBar(searchText: $searchText)
                        .padding(.horizontal, 20)
                        .padding(.bottom, 24)
                    
                    // Êú™ÂΩíÊ°£ËÆ∞ÂΩïÔºàÂæÖÊï¥ÁêÜÔºâ
                    if !unarchivedRecords.isEmpty {
                        VStack(alignment: .leading, spacing: 12) {
                            HStack {
                                Text("ÂæÖÂΩíÊ°£")
                                    .font(.system(size: 14, weight: .semibold))
                                    .foregroundColor(.textSecondary)
                                    .textCase(.uppercase)
                                    .tracking(0.05)
                                
                                Spacer()
                                
                                Text("\(unarchivedRecords.count)")
                                    .font(.system(size: 13, weight: .medium))
                                    .foregroundColor(.white)
                                    .padding(.horizontal, 8)
                                    .padding(.vertical, 4)
                                    .background(Color.orange)
                                    .cornerRadius(8)
                            }
                            .padding(.horizontal, 20)
                            
                            ForEach(unarchivedRecords) { record in
                                SwipeableRecordCard(record: record)
                                    .padding(.horizontal, 20)
                            }
                        }
                        .padding(.bottom, 24)
                    }
                    
                    // Â∑≤ÂΩíÊ°£ËÆ∞ÂΩï
                    if !archivedRecords.isEmpty {
                        VStack(alignment: .leading, spacing: 12) {
                            Text("Â∞±ËØäËÆ∞ÂΩï")
                                .font(.system(size: 14, weight: .semibold))
                                .foregroundColor(.textSecondary)
                                .textCase(.uppercase)
                                .tracking(0.05)
                                .padding(.horizontal, 20)
                            
                            ForEach(archivedRecords) { record in
                                SwipeableRecordCard(record: record)
                                    .padding(.horizontal, 20)
                            }
                        }
                        .padding(.bottom, 20)
                    }
                    
                    // Á©∫Áä∂ÊÄÅ
                    if unarchivedRecords.isEmpty && archivedRecords.isEmpty {
                        VStack(spacing: 16) {
                            Image(systemName: "doc.text")
                                .font(.system(size: 48))
                                .foregroundColor(.textSecondary.opacity(0.5))
                            
                            Text("ÊöÇÊó†Â∞±ËØäËÆ∞ÂΩï")
                                .font(.system(size: 16))
                                .foregroundColor(.textSecondary)
                            
                            Text("ÁÇπÂáªÂè≥‰∏äËßí + Âè∑Ê∑ªÂä†ËÆ∞ÂΩï")
                                .font(.system(size: 14))
                                .foregroundColor(.textSecondary.opacity(0.7))
                        }
                        .frame(maxWidth: .infinity)
                        .padding(.vertical, 80)
                    }
                }
            }
            .background(Color.appBackgroundColor)
            .navigationBarHidden(true)
            .sheet(isPresented: $showingAddCase) {
                AddCaseStepView()
                    .environmentObject(healthDataManager)
            }
        }
        .navigationViewStyle(StackNavigationViewStyle())
    }
}

// MARK: - Records Header
struct RecordsHeader: View {
    @Binding var showingAddCase: Bool
    
    var body: some View {
        HStack(alignment: .top) {
            VStack(alignment: .leading, spacing: 4) {
                Text("Â∞±ËØäËÆ∞ÂΩï")
                    .font(.system(size: 28, weight: .semibold))
                    .foregroundColor(.textPrimary)
                
                Text("ÁóÖÂéÜ‰∏éÊ°£Ê°àÁÆ°ÁêÜ")
                    .font(.system(size: 13))
                    .foregroundColor(.textSecondary)
            }
            
            Spacer()
            
            Button(action: {
                showingAddCase = true
            }) {
                ZStack {
                    RoundedRectangle(cornerRadius: 10, style: .continuous)
                        .fill(
                            LinearGradient(
                                colors: [Color.accentPrimary, Color.accentTertiary],
                                startPoint: .topLeading,
                                endPoint: .bottomTrailing
                            )
                        )
                        .frame(width: 36, height: 36)
                        .shadow(color: Color.accentPrimary.opacity(0.3), radius: 4, x: 0, y: 2)
                    
                    Image(systemName: "plus")
                        .font(.system(size: 18, weight: .bold, design: .rounded))
                        .foregroundColor(.white)
                }
            }
        }
    }
}

// MARK: - Search Bar
struct SearchBar: View {
    @Binding var searchText: String
    
    var body: some View {
        HStack(spacing: 12) {
            Image(systemName: "magnifyingglass")
                .font(.system(size: 20))
                .foregroundColor(.textSecondary)
            
            TextField("ÊêúÁ¥¢ÂåªÈô¢„ÄÅÁßëÂÆ§„ÄÅÊó•Êúü...", text: $searchText)
                .font(.system(size: 14))
                .foregroundColor(.textPrimary)
        }
        .padding(12)
        .background(Color.secondaryBackgroundColor)
        .cornerRadius(16)
    }
}

// MARK: - Record Card View
struct RecordCardView: View {
    @EnvironmentObject var healthDataManager: HealthDataManager
    let record: HealthRecord
    @State private var showingMergeSelection = false
    @State private var showingDeleteConfirm = false
    @State private var refreshID = UUID()
    
    private var dateString: String {
        let formatter = DateFormatter()
        formatter.dateFormat = "yyyy-MM-dd Â∞±ËØä"
        return formatter.string(from: record.date)
    }
    
    private var items: [CaseItem] {
        var itemList: [CaseItem] = []
        
        // Ê∑ªÂä†ÂΩïÈü≥ËÆ∞ÂΩï
        for (index, audio) in record.audioRecordings.enumerated() {
            let minutes = Int(audio.duration) / 60
            let title = audio.title ?? "ÂΩïÈü≥ËÆ∞ÂΩï \(index + 1)"
            itemList.append(CaseItem(icon: "mic.fill", text: "\(title) (\(minutes)ÂàÜÈíü)"))
        }
        
        // Ê∑ªÂä†ÈôÑ‰ª∂
        if !record.attachments.isEmpty {
            itemList.append(CaseItem(icon: "doc.fill", text: "Ê£ÄÊü•Êä•Âëä - \(record.attachments.count)Âº†"))
        }
        
        // Ê∑ªÂä†ËØäÊñ≠
        if let diagnosis = record.diagnosis, !diagnosis.isEmpty {
            itemList.append(CaseItem(icon: "stethoscope", text: "ËØäÊñ≠: \(diagnosis)"))
        }
        
        // Â¶ÇÊûúÊ≤°Êúâ‰ªª‰ΩïÂÜÖÂÆπÔºåÊòæÁ§∫ÁóáÁä∂
        if itemList.isEmpty {
            itemList.append(CaseItem(icon: "doc.text", text: record.symptoms))
        }
        
        return itemList
    }
    
    var body: some View {
        NavigationLink(destination: RecordDetailView(record: record)) {
            VStack(alignment: .leading, spacing: 12) {
                HStack(alignment: .top) {
                    VStack(alignment: .leading, spacing: 4) {
                        Text(record.hospitalName)
                            .font(.system(size: 16, weight: .semibold))
                            .foregroundColor(.textPrimary)
                        
                        Text(dateString)
                            .font(.system(size: 12))
                            .foregroundColor(.textSecondary)
                    }
                    
                    Spacer()
                    
                    HStack(spacing: 8) {
                        Text(record.department)
                            .font(.system(size: 11, weight: .medium))
                            .foregroundColor(.textSecondary)
                            .padding(.horizontal, 8)
                            .padding(.vertical, 4)
                            .background(Color.secondaryBackgroundColor)
                            .cornerRadius(6)
                        
                        if !record.isArchived {
                            // Ê∑ªÂä†ÊåâÈíÆ
                            Button(action: {
                                showingMergeSelection = true
                            }) {
                                Image(systemName: "plus.circle")
                                    .font(.system(size: 14))
                                    .foregroundColor(.blue)
                                    .padding(6)
                                    .background(Color.blue.opacity(0.1))
                                    .cornerRadius(6)
                            }
                            .buttonStyle(PlainButtonStyle())
                            
                            // Âà†Èô§ÊåâÈíÆ
                            Button(action: {
                                showingDeleteConfirm = true
                            }) {
                                Image(systemName: "trash")
                                    .font(.system(size: 14))
                                    .foregroundColor(.red)
                                    .padding(6)
                                    .background(Color.red.opacity(0.1))
                                    .cornerRadius(6)
                            }
                            .buttonStyle(PlainButtonStyle())
                        }
                    }
                }
                
                VStack(alignment: .leading, spacing: 8) {
                    ForEach(items) { item in
                        HStack(alignment: .center, spacing: 12) {
                            Image(systemName: item.icon)
                                .font(.system(size: 16))
                                .foregroundColor(.textSecondary)
                                .frame(width: 20, height: 20)
                            
                            Text(item.text)
                                .font(.system(size: 13))
                                .foregroundColor(.textSecondary)
                                .frame(maxWidth: .infinity, alignment: .leading)
                                .lineLimit(2)
                        }
                        .frame(maxWidth: .infinity, alignment: .leading)
                        .padding(12)
                        .background(Color.secondaryBackgroundColor)
                        .cornerRadius(12)
                    }
                }
            }
            .padding(20)
            .background(Color.cardBackgroundColor)
            .cornerRadius(20)
            .overlay(
                RoundedRectangle(cornerRadius: 20)
                    .stroke(record.isArchived ? Color.dividerColor : Color.orange.opacity(0.3), lineWidth: record.isArchived ? 1 : 2)
            )
        }
        .buttonStyle(PlainButtonStyle())
        .sheet(isPresented: $showingMergeSelection) {
            RecordMergeSelectionSheet(
                sourceRecord: record,
                onMerge: mergeToRecord
            )
            .environmentObject(healthDataManager)
            .id(refreshID) // Âº∫Âà∂Âà∑Êñ∞
            .onAppear {
                // ÊØèÊ¨°ÊâìÂºÄÊó∂Âà∑Êñ∞
                refreshID = UUID()
            }
        }
        .alert("Âà†Èô§ËÆ∞ÂΩï", isPresented: $showingDeleteConfirm) {
            Button("ÂèñÊ∂à", role: .cancel) { }
            Button("Âà†Èô§", role: .destructive) {
                deleteRecord()
            }
        } message: {
            Text("Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ")
        }
    }
    
    private func mergeToRecord(_ targetRecord: HealthRecord) {
        var updatedTarget = targetRecord
        
        // ÂêàÂπ∂ÂΩïÈü≥
        updatedTarget.audioRecordings.append(contentsOf: record.audioRecordings)
        
        // ÂêàÂπ∂ÈôÑ‰ª∂
        updatedTarget.attachments.append(contentsOf: record.attachments)
        
        // ÂêàÂπ∂ÁóáÁä∂‰ø°ÊÅØÔºàÂ¶ÇÊûúÁõÆÊ†áËÆ∞ÂΩïÁöÑÁóáÁä∂‰∏∫Á©∫Êàñ‰∏∫"ÂæÖË°•ÂÖÖ"Ôºâ
        if updatedTarget.symptoms.isEmpty || updatedTarget.symptoms == "ÂæÖË°•ÂÖÖ" || updatedTarget.symptoms.contains("ÂΩïÈü≥ËÆ∞ÂΩï") || updatedTarget.symptoms.contains("Êä•ÂëäÁÖßÁâá") {
            if !record.symptoms.isEmpty && record.symptoms != "ÂæÖË°•ÂÖÖ" && !record.symptoms.contains("ÂΩïÈü≥ËÆ∞ÂΩï") && !record.symptoms.contains("Êä•ÂëäÁÖßÁâá") {
                updatedTarget.symptoms = record.symptoms
            }
        }
        
        // Êõ¥Êñ∞ÁõÆÊ†áËÆ∞ÂΩï
        healthDataManager.updateHealthRecord(updatedTarget)
        
        // Âà†Èô§Ê∫êËÆ∞ÂΩï
        healthDataManager.deleteHealthRecord(record)
    }
    
    private func deleteRecord() {
        healthDataManager.deleteHealthRecord(record)
    }
}

// MARK: - Case Record Card
struct CaseRecordCard: View {
    let hospital: String
    let department: String
    let date: String
    let items: [CaseItem]
    
    var body: some View {
        VStack(alignment: .leading, spacing: 12) {
            HStack(alignment: .top) {
                VStack(alignment: .leading, spacing: 4) {
                    Text(hospital)
                        .font(.system(size: 16, weight: .semibold))
                        .foregroundColor(.textPrimary)
                    
                    Text(date)
                        .font(.system(size: 12))
                        .foregroundColor(.textSecondary)
                }
                
                Spacer()
                
                Text(department)
                    .font(.system(size: 11, weight: .medium))
                    .foregroundColor(.textSecondary)
                    .padding(.horizontal, 8)
                    .padding(.vertical, 4)
                    .background(Color.secondaryBackgroundColor)
                    .cornerRadius(6)
            }
            
            VStack(alignment: .leading, spacing: 8) {
                ForEach(items) { item in
                        HStack(alignment: .center, spacing: 12) {
                            Image(systemName: item.icon)
                                .font(.system(size: 16))
                                .foregroundColor(.textSecondary)
                                .frame(width: 20, height: 20)
                            
                            Text(item.text)
                                .font(.system(size: 13))
                                .foregroundColor(.textSecondary)
                                .frame(maxWidth: .infinity, alignment: .leading)
                        }
                        .frame(maxWidth: .infinity, alignment: .leading)
                        .padding(12)
                        .background(Color.secondaryBackgroundColor)
                        .cornerRadius(12)
                }
            }
        }
        .padding(20)
        .background(Color.cardBackgroundColor)
        .cornerRadius(20)
        .overlay(
            RoundedRectangle(cornerRadius: 20)
                .stroke(Color.dividerColor, lineWidth: 1)
        )
    }
}

// MARK: - Add Case View (ÂàÜÊ≠•ÂºïÂØºÂºè)
struct AddCaseView: View {
    @Environment(\.dismiss) var dismiss
    
    // ÂΩìÂâçÊ≠•È™§
    @State private var currentStep = 1
    let totalSteps = 5
    
    // Ë°®ÂçïÊï∞ÊçÆ
    @State private var hospitalName = ""
    @State private var department = ""
    @State private var doctorName = ""
    @State private var visitDate = Date()
    @State private var symptoms = ""
    @State private var diagnosis = ""
    @State private var treatment = ""
    @State private var prescription = ""
    @State private var notes = ""
    @State private var showingImagePicker = false
    @State private var selectedImages: [String] = []
    
    var progressPercentage: CGFloat {
        CGFloat(currentStep) / CGFloat(totalSteps)
    }
    
    var body: some View {
        NavigationView {
            VStack(spacing: 0) {
                // È°∂ÈÉ®ËøõÂ∫¶Êù°
                VStack(spacing: 0) {
                    // ËøõÂ∫¶Êù°
                    GeometryReader { geometry in
                        ZStack(alignment: .leading) {
                            Rectangle()
                                .fill(Color.secondaryBackgroundColor)
                                .frame(height: 4)
                            
                            Rectangle()
                                .fill(Color.textPrimary)
                                .frame(width: geometry.size.width * progressPercentage, height: 4)
                                .animation(.easeInOut(duration: 0.3), value: currentStep)
                        }
                    }
                    .frame(height: 4)
                    
                    // Ê≠•È™§ÊåáÁ§∫
                    HStack {
                        Text("Á¨¨ \(currentStep) Ê≠•ÔºåÂÖ± \(totalSteps) Ê≠•")
                            .font(.system(size: 14, weight: .medium))
                            .foregroundColor(.textSecondary)
                        
                        Spacer()
                    }
                    .padding(.horizontal, 20)
                    .padding(.vertical, 12)
                }
                .background(Color.appBackgroundColor)
                
                // Ê≠•È™§ÂÜÖÂÆπ
                TabView(selection: $currentStep) {
                    // Âü∫Êú¨‰ø°ÊÅØ
                    VStack(alignment: .leading, spacing: 16) {
                        Text("Âü∫Êú¨‰ø°ÊÅØ")
                            .font(.system(size: 16, weight: .semibold))
                            .foregroundColor(Color(red: 55/255, green: 53/255, blue: 47/255))
                        
                        VStack(alignment: .leading, spacing: 8) {
                            Text("ÂåªÈô¢ÂêçÁß∞ *")
                                .font(.system(size: 14, weight: .medium))
                                .foregroundColor(Color(red: 55/255, green: 53/255, blue: 47/255))
                            
                            TextField("ËØ∑ËæìÂÖ•ÂåªÈô¢ÂêçÁß∞", text: $hospitalName)
                                .font(.system(size: 15))
                                .padding(12)
                                .background(Color(red: 250/255, green: 250/255, blue: 250/255))
                                .cornerRadius(12)
                        }
                        
                        VStack(alignment: .leading, spacing: 8) {
                            Text("ÁßëÂÆ§ *")
                                .font(.system(size: 14, weight: .medium))
                                .foregroundColor(Color(red: 55/255, green: 53/255, blue: 47/255))
                            
                            TextField("ËØ∑ËæìÂÖ•ÁßëÂÆ§", text: $department)
                                .font(.system(size: 15))
                                .padding(12)
                                .background(Color(red: 250/255, green: 250/255, blue: 250/255))
                                .cornerRadius(12)
                        }
                        
                        VStack(alignment: .leading, spacing: 8) {
                            Text("ÂåªÁîüÂßìÂêç")
                                .font(.system(size: 14, weight: .medium))
                                .foregroundColor(Color(red: 55/255, green: 53/255, blue: 47/255))
                            
                            TextField("ËØ∑ËæìÂÖ•ÂåªÁîüÂßìÂêç", text: $doctorName)
                                .font(.system(size: 15))
                                .padding(12)
                                .background(Color(red: 250/255, green: 250/255, blue: 250/255))
                                .cornerRadius(12)
                        }
                        
                        VStack(alignment: .leading, spacing: 8) {
                            Text("Â∞±ËØäÊó•Êúü *")
                                .font(.system(size: 14, weight: .medium))
                                .foregroundColor(Color(red: 55/255, green: 53/255, blue: 47/255))
                            
                            DatePicker("", selection: $visitDate, displayedComponents: .date)
                                .datePickerStyle(.compact)
                                .padding(12)
                                .background(Color(red: 250/255, green: 250/255, blue: 250/255))
                                .cornerRadius(12)
                        }
                    }
                    
                    Divider()
                    
                    // Â∞±ËØäËØ¶ÊÉÖ
                    VStack(alignment: .leading, spacing: 16) {
                        Text("Â∞±ËØäËØ¶ÊÉÖ")
                            .font(.system(size: 16, weight: .semibold))
                            .foregroundColor(Color(red: 55/255, green: 53/255, blue: 47/255))
                        
                        VStack(alignment: .leading, spacing: 8) {
                            Text("‰∏ªË¶ÅÁóáÁä∂ *")
                                .font(.system(size: 14, weight: .medium))
                                .foregroundColor(Color(red: 55/255, green: 53/255, blue: 47/255))
                            
                            TextEditor(text: $symptoms)
                                .font(.system(size: 15))
                                .frame(minHeight: 80)
                                .padding(12)
                                .background(Color(red: 250/255, green: 250/255, blue: 250/255))
                                .cornerRadius(12)
                        }
                        
                        VStack(alignment: .leading, spacing: 8) {
                            Text("ËØäÊñ≠ÁªìÊûú")
                                .font(.system(size: 14, weight: .medium))
                                .foregroundColor(Color(red: 55/255, green: 53/255, blue: 47/255))
                            
                            TextEditor(text: $diagnosis)
                                .font(.system(size: 15))
                                .frame(minHeight: 80)
                                .padding(12)
                                .background(Color(red: 250/255, green: 250/255, blue: 250/255))
                                .cornerRadius(12)
                        }
                        
                        VStack(alignment: .leading, spacing: 8) {
                            Text("Ê≤ªÁñóÊñπÊ°à")
                                .font(.system(size: 14, weight: .medium))
                                .foregroundColor(Color(red: 55/255, green: 53/255, blue: 47/255))
                            
                            TextEditor(text: $treatment)
                                .font(.system(size: 15))
                                .frame(minHeight: 80)
                                .padding(12)
                                .background(Color(red: 250/255, green: 250/255, blue: 250/255))
                                .cornerRadius(12)
                        }
                        
                        VStack(alignment: .leading, spacing: 8) {
                            Text("Â§ÑÊñπËçØÁâ©")
                                .font(.system(size: 14, weight: .medium))
                                .foregroundColor(Color(red: 55/255, green: 53/255, blue: 47/255))
                            
                            TextEditor(text: $prescription)
                                .font(.system(size: 15))
                                .frame(minHeight: 60)
                                .padding(12)
                                .background(Color(red: 250/255, green: 250/255, blue: 250/255))
                                .cornerRadius(12)
                        }
                    }
                    
                    Divider()
                    
                    // ÈôÑ‰ª∂
                    VStack(alignment: .leading, spacing: 12) {
                        Text("ÈôÑ‰ª∂")
                            .font(.system(size: 16, weight: .semibold))
                            .foregroundColor(Color(red: 55/255, green: 53/255, blue: 47/255))
                        
                        Button(action: {
                            showingImagePicker = true
                        }) {
                            VStack(spacing: 12) {
                                Image(systemName: "photo.on.rectangle.angled")
                                    .font(.system(size: 28))
                                    .foregroundColor(Color(red: 155/255, green: 154/255, blue: 151/255))
                                
                                Text("Ê∑ªÂä†Ê£ÄÊü•Êä•ÂëäÊàñÁÖßÁâá")
                                    .font(.system(size: 14))
                                    .foregroundColor(Color(red: 120/255, green: 119/255, blue: 116/255))
                            }
                            .frame(maxWidth: .infinity)
                            .frame(height: 120)
                            .background(Color(red: 250/255, green: 250/255, blue: 250/255))
                            .cornerRadius(12)
                            .overlay(
                                RoundedRectangle(cornerRadius: 12)
                                    .strokeBorder(Color(red: 233/255, green: 233/255, blue: 231/255), style: StrokeStyle(lineWidth: 2, dash: [8, 4]))
                            )
                        }
                    }
                    
                    Divider()
                    
                    // Â§áÊ≥®
                    VStack(alignment: .leading, spacing: 8) {
                        Text("Â§áÊ≥®")
                            .font(.system(size: 16, weight: .semibold))
                            .foregroundColor(Color(red: 55/255, green: 53/255, blue: 47/255))
                        
                        TextEditor(text: $notes)
                            .font(.system(size: 15))
                            .frame(minHeight: 80)
                            .padding(12)
                            .background(Color(red: 250/255, green: 250/255, blue: 250/255))
                            .cornerRadius(12)
                    }
                    
                    // ‰øùÂ≠òÊåâÈíÆ
                    Button(action: {
                        // ‰øùÂ≠òÁóÖÂéÜ
                        dismiss()
                    }) {
                        Text("‰øùÂ≠òÁóÖÂéÜ")
                            .font(.system(size: 16, weight: .semibold))
                            .foregroundColor(.white)
                            .frame(maxWidth: .infinity)
                            .padding(.vertical, 16)
                            .background(Color(red: 55/255, green: 53/255, blue: 47/255))
                            .cornerRadius(12)
                    }
                    .disabled(hospitalName.isEmpty || department.isEmpty || symptoms.isEmpty)
                    .opacity(hospitalName.isEmpty || department.isEmpty || symptoms.isEmpty ? 0.5 : 1.0)
                }
                .padding(24)
            }
            .background(Color.appBackgroundColor)
            .navigationTitle("ÂàõÂª∫Êñ∞ÁóÖÂéÜ")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarLeading) {
                    Button("ÂèñÊ∂à") {
                        dismiss()
                    }
                    .foregroundColor(Color(red: 120/255, green: 119/255, blue: 116/255))
                }
            }
        }
        .sheet(isPresented: $showingImagePicker) {
            Text("ÂõæÁâáÈÄâÊã©Âô®")
        }
    }
}

// MARK: - Case Detail View
struct CaseDetailView: View {
    let hospital: String
    let department: String
    let date: String
    let items: [CaseItem]
    @Environment(\.dismiss) var dismiss
    @State private var isEditMode = false
    
    var body: some View {
        ZStack {
            Color.appBackgroundColor.ignoresSafeArea()
            
            VStack(spacing: 0) {
                // Ëá™ÂÆö‰πâÂØºËà™Ê†è
                HStack(spacing: 12) {
                    Button(action: { dismiss() }) {
                        Image(systemName: "chevron.left")
                            .font(.system(size: 18, weight: .medium))
                            .foregroundColor(.textPrimary)
                            .frame(width: 32, height: 32)
                    }
                    
                    VStack(alignment: .leading, spacing: 4) {
                        Text(hospital)
                            .font(.system(size: 20, weight: .semibold))
                            .foregroundColor(Color(red: 55/255, green: 53/255, blue: 47/255))
                        
                        HStack(spacing: 12) {
                            Text(department)
                                .font(.system(size: 13))
                                .foregroundColor(Color(red: 155/255, green: 154/255, blue: 151/255))
                            
                            Text(date)
                                .font(.system(size: 13))
                                .foregroundColor(Color(red: 155/255, green: 154/255, blue: 151/255))
                        }
                    }
                    
                    Spacer()
                    
                    Button(action: { isEditMode.toggle() }) {
                        Image(systemName: isEditMode ? "checkmark" : "square.and.pencil")
                            .font(.system(size: 16))
                            .foregroundColor(isEditMode ? .white : Color(red: 120/255, green: 119/255, blue: 116/255))
                            .frame(width: 32, height: 32)
                            .background(isEditMode ? Color(red: 55/255, green: 53/255, blue: 47/255) : Color.clear)
                            .cornerRadius(8)
                    }
                }
                .padding(.horizontal, 20)
                .padding(.vertical, 16)
                .background(Color(red: 255/255, green: 255/255, blue: 255/255))
                .overlay(
                    Rectangle()
                        .fill(Color(red: 241/255, green: 241/255, blue: 239/255))
                        .frame(height: 1),
                    alignment: .bottom
                )
                
                ScrollView(showsIndicators: false) {
                    VStack(alignment: .leading, spacing: 32) {
                        // ÁóÖ‰æãÂü∫Êú¨‰ø°ÊÅØ
                        RecordDetailSection(
                            icon: "doc.text",
                            title: "ÁóÖ‰æã‰ø°ÊÅØ"
                        ) {
                            EmptyView()
                        }
                        
                        // ÂΩïÈü≥ËÆ∞ÂΩï
                        RecordDetailSection(
                            icon: "mic",
                            title: "ÂΩïÈü≥ËÆ∞ÂΩï"
                        ) {
                            AudioPlayerView(
                                title: "Âº†ÂåªÁîüËØäÊñ≠ÂΩïÈü≥",
                                duration: "5ÂàÜÈíü",
                                date: "2025-10-20"
                            )
                        }
                        
                        // Ê£ÄÊü•Êä•Âëä
                        RecordDetailSection(
                            icon: "doc.text",
                            title: "Ê£ÄÊü•Êä•Âëä"
                        ) {
                            LazyVGrid(columns: [
                                GridItem(.flexible(), spacing: 12),
                                GridItem(.flexible(), spacing: 12)
                            ], spacing: 12) {
                                ReportImageCard(imageName: "Ë°ÄÂ∏∏ËßÑÊä•Âëä")
                                ReportImageCard(imageName: "ÂøÉÁîµÂõæÊä•Âëä")
                            }
                        }
                        
                        // Â§ÑÊñπÂçï
                        RecordDetailSection(
                            icon: "doc.on.clipboard",
                            title: "Â§ÑÊñπÂçï"
                        ) {
                            VStack(alignment: .leading, spacing: 16) {
                                PrescriptionImageCard()
                                
                                VStack(alignment: .leading, spacing: 8) {
                                    Text("OCRËØÜÂà´ÊñáÊú¨")
                                        .font(.system(size: 14, weight: .semibold))
                                        .foregroundColor(Color(red: 55/255, green: 53/255, blue: 47/255))
                                    
                                    Text("""
                                    Âåó‰∫¨ÂçèÂíåÂåªÈô¢Â§ÑÊñπÂçï
                                    
                                    ÊÇ£ËÄÖÂßìÂêçÔºöÂº†‰∏â
                                    ÊÄßÂà´ÔºöÁî∑
                                    Âπ¥ÈæÑÔºö58Â≤Å
                                    ÁßëÂÆ§ÔºöÂøÉË°ÄÁÆ°Áßë
                                    Êó•ÊúüÔºö2025-10-20
                                    
                                    ËçØÂìÅÂêçÁß∞               ËßÑÊ†º        Êï∞Èáè    Áî®Ê≥ïÁî®Èáè
                                    ÈòøÂè∏ÂåπÊûóËÇ†Ê∫∂Áâá        100mg       30Áâá    ÊØèÊó•‰∏ÄÊ¨°ÔºåÊØèÊ¨°1Áâá
                                    ÈôçÂéãËçØÁâá              5mg         30Áâá    ÊØèÊó•‰∏ÄÊ¨°ÔºåÊØèÊ¨°1Áâá
                                    
                                    ÂåªÁîüÁ≠æÂêçÔºöÂº†ÂåªÁîü
                                    """)
                                    .font(.system(size: 14))
                                    .foregroundColor(Color(red: 120/255, green: 119/255, blue: 116/255))
                                    .lineSpacing(4)
                                    .padding(16)
                                    .frame(maxWidth: .infinity, alignment: .leading)
                                    .background(Color(red: 250/255, green: 250/255, blue: 250/255))
                                    .cornerRadius(12)
                                }
                            }
                        }
                        
                        // AIËß£ËØªÊä•Âëä
                        RecordDetailSection(
                            icon: "lightbulb",
                            title: "AIËß£ËØªÊä•Âëä"
                        ) {
                            VStack(alignment: .leading, spacing: 12) {
                                Text("Êô∫ËÉΩÂàÜÊûê")
                                    .font(.system(size: 15, weight: .semibold))
                                    .foregroundColor(Color(red: 55/255, green: 53/255, blue: 47/255))
                                
                                Text("""
                                Ê†πÊçÆÊÇ®ÁöÑÊ£ÄÊü•Êä•ÂëäÂíåÂ§ÑÊñπÔºåAIÂàÜÊûêÂ¶Ç‰∏ãÔºö
                                
                                1. Ë°ÄÂ∏∏ËßÑÊ£ÄÊü•ÁªìÊûúÊ≠£Â∏∏ÔºåÂêÑÈ°πÊåáÊ†áÂùáÂú®Ê≠£Â∏∏ËåÉÂõ¥ÂÜÖÔºåËØ¥ÊòéÊï¥‰ΩìÂÅ•Â∫∑Áä∂ÂÜµËâØÂ•Ω„ÄÇ
                                
                                2. ÂøÉÁîµÂõæÊòæÁ§∫ËΩªÂæÆSTÊÆµÊîπÂèòÔºåÂª∫ËÆÆÂÆöÊúüÂ§çÊü•„ÄÇÂèØËÉΩ‰∏éÂøÉË°ÄÁÆ°ÁñæÁóÖÁõ∏ÂÖ≥ÔºåÈúÄË¶ÅÊ≥®ÊÑè‰ºëÊÅØÔºåÈÅøÂÖçËøáÂ∫¶Âä≥Á¥Ø„ÄÇ
                                
                                3. Â§ÑÊñπÁî®ËçØÂêàÁêÜÔºö
                                   - ÈòøÂè∏ÂåπÊûóÁî®‰∫éÊäóË°ÄÂ∞èÊùøËÅöÈõÜÔºåÈ¢ÑÈò≤ÂøÉË°ÄÁÆ°‰∫ã‰ª∂
                                   - ÈôçÂéãËçØÁî®‰∫éÊéßÂà∂Ë°ÄÂéã
                                   ‰∏§È°πËçØÁâ©Êê≠ÈÖç‰ΩøÁî®ÔºåÊúâÂä©‰∫éÂøÉË°ÄÁÆ°ÂÅ•Â∫∑ÁÆ°ÁêÜ„ÄÇ
                                
                                Âª∫ËÆÆÔºö‰øùÊåÅËßÑÂæã‰ΩúÊÅØÔºåÈÄÇÂ∫¶ËøêÂä®ÔºåÊåâÊó∂ÊúçËçØÔºå3‰∏™ÊúàÂêéÂ§çÊü•„ÄÇ
                                """)
                                .font(.system(size: 14))
                                .foregroundColor(Color(red: 120/255, green: 119/255, blue: 116/255))
                                .lineSpacing(6)
                            }
                            .padding(20)
                            .frame(maxWidth: .infinity, alignment: .leading)
                            .background(Color(red: 250/255, green: 250/255, blue: 250/255))
                            .cornerRadius(16)
                        }
                        
                        // AIÈóÆËØ¢
                        RecordDetailSection(
                            icon: "message",
                            title: "AIÈóÆËØ¢"
                        ) {
                            AIChatView()
                        }
                    }
                    .padding(20)
                }
            }
        }
        .navigationBarHidden(true)
    }
}

// MARK: - Record Detail Section Component
struct RecordDetailSection<Content: View>: View {
    let icon: String
    let title: String
    let content: Content
    
    init(icon: String, title: String, @ViewBuilder content: () -> Content) {
        self.icon = icon
        self.title = title
        self.content = content()
    }
    
    var body: some View {
        VStack(alignment: .leading, spacing: 16) {
            HStack(spacing: 8) {
                Image(systemName: icon)
                    .font(.system(size: 16))
                    .foregroundColor(Color(red: 55/255, green: 53/255, blue: 47/255))
                
                Text(title)
                    .font(.system(size: 16, weight: .semibold))
                    .foregroundColor(Color(red: 55/255, green: 53/255, blue: 47/255))
            }
            
            content
        }
    }
}

// MARK: - Audio Player Component
struct AudioPlayerView: View {
    let title: String
    let duration: String
    let date: String
    @State private var isPlaying = false
    
    var body: some View {
        HStack(spacing: 12) {
            Button(action: { isPlaying.toggle() }) {
                Image(systemName: isPlaying ? "pause.fill" : "play.fill")
                    .font(.system(size: 20))
                    .foregroundColor(.white)
                    .frame(width: 48, height: 48)
                    .background(Color(red: 55/255, green: 53/255, blue: 47/255))
                    .clipShape(Circle())
            }
            
            VStack(alignment: .leading, spacing: 4) {
                Text(title)
                    .font(.system(size: 15, weight: .medium))
                    .foregroundColor(Color(red: 55/255, green: 53/255, blue: 47/255))
                
                Text("\(duration) ¬∑ \(date)")
                    .font(.system(size: 13))
                    .foregroundColor(Color(red: 155/255, green: 154/255, blue: 151/255))
            }
            
            Spacer()
        }
        .padding(16)
        .background(Color(red: 250/255, green: 250/255, blue: 250/255))
        .cornerRadius(16)
    }
}

// MARK: - Report Image Card
struct ReportImageCard: View {
    let imageName: String
    
    var body: some View {
        ZStack {
            Rectangle()
                .fill(Color(red: 245/255, green: 245/255, blue: 243/255))
                .aspectRatio(3/4, contentMode: .fit)
                .cornerRadius(16)
                .overlay(
                    RoundedRectangle(cornerRadius: 16)
                        .stroke(Color(red: 233/255, green: 233/255, blue: 231/255), lineWidth: 1)
                )
            
            VStack(spacing: 8) {
                Image(systemName: "doc.text")
                    .font(.system(size: 32))
                    .foregroundColor(Color(red: 155/255, green: 154/255, blue: 151/255))
                
                Text(imageName)
                    .font(.system(size: 12))
                    .foregroundColor(Color(red: 120/255, green: 119/255, blue: 116/255))
            }
        }
    }
}

// MARK: - Prescription Image Card
struct PrescriptionImageCard: View {
    var body: some View {
        ZStack {
            Rectangle()
                .fill(Color(red: 245/255, green: 245/255, blue: 243/255))
                .aspectRatio(4/3, contentMode: .fit)
                .cornerRadius(16)
                .overlay(
                    RoundedRectangle(cornerRadius: 16)
                        .stroke(Color(red: 233/255, green: 233/255, blue: 231/255), lineWidth: 1)
                )
            
            VStack(spacing: 8) {
                Image(systemName: "doc.on.clipboard")
                    .font(.system(size: 40))
                    .foregroundColor(Color(red: 155/255, green: 154/255, blue: 151/255))
                
                Text("Â§ÑÊñπÂçï")
                    .font(.system(size: 14))
                    .foregroundColor(Color(red: 120/255, green: 119/255, blue: 116/255))
            }
        }
    }
}

// MARK: - AI Chat View
struct AIChatView: View {
    @State private var messages: [AIChatMessage] = [
        AIChatMessage(text: "ÊÇ®Â•ΩÔºÅÊàëÊòØAIÂÅ•Â∫∑Âä©ÊâãÔºåÊàëÂèØ‰ª•Âü∫‰∫éÊÇ®ÁöÑÊ£ÄÊü•Êä•ÂëäÂíåÂ§ÑÊñπÂÜÖÂÆπÂõûÁ≠îÁõ∏ÂÖ≥ÈóÆÈ¢ò„ÄÇËØ∑ÈóÆÊúâ‰ªÄ‰πàÊÉ≥‰∫ÜËß£ÁöÑÂêóÔºü", isUser: false)
    ]
    @State private var inputText = ""
    
    var body: some View {
        VStack(alignment: .leading, spacing: 16) {
            Text("Âü∫‰∫éÊä•ÂëäÂÜÖÂÆπÊèêÈóÆ")
                .font(.system(size: 15, weight: .semibold))
                .foregroundColor(Color(red: 55/255, green: 53/255, blue: 47/255))
            
            VStack(alignment: .leading, spacing: 12) {
                ForEach(messages) { message in
                    HStack {
                        if message.isUser {
                            Spacer()
                        }
                        
                        Text(message.text)
                            .font(.system(size: 14))
                            .foregroundColor(message.isUser ? .white : Color(red: 55/255, green: 53/255, blue: 47/255))
                            .padding(12)
                            .background(message.isUser ? Color(red: 55/255, green: 53/255, blue: 47/255) : Color(red: 245/255, green: 245/255, blue: 243/255))
                            .cornerRadius(12)
                        
                        if !message.isUser {
                            Spacer()
                        }
                    }
                }
            }
            
            HStack(spacing: 8) {
                TextField("ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢ò...", text: $inputText)
                    .font(.system(size: 14))
                    .padding(12)
                    .background(Color(red: 250/255, green: 250/255, blue: 250/255))
                    .cornerRadius(12)
                
                Button(action: sendMessage) {
                    Image(systemName: "paperplane.fill")
                        .font(.system(size: 16))
                        .foregroundColor(.white)
                        .frame(width: 40, height: 40)
                        .background(Color(red: 55/255, green: 53/255, blue: 47/255))
                        .cornerRadius(12)
                }
                .disabled(inputText.isEmpty)
                .opacity(inputText.isEmpty ? 0.5 : 1.0)
            }
        }
        .padding(20)
        .background(Color(red: 250/255, green: 250/255, blue: 250/255))
        .cornerRadius(16)
    }
    
    private func sendMessage() {
        guard !inputText.isEmpty else { return }
        
        messages.append(AIChatMessage(text: inputText, isUser: true))
        inputText = ""
        
        // Ê®°ÊãüAIÂõûÂ§ç
        DispatchQueue.main.asyncAfter(deadline: .now() + 1) {
            messages.append(AIChatMessage(text: "ÊÑüË∞¢ÊÇ®ÁöÑÊèêÈóÆÔºÅËøôÊòØ‰∏Ä‰∏™Ê®°ÊãüÁöÑAIÂõûÂ§ç„ÄÇÂú®ÂÆûÈôÖÂ∫îÁî®‰∏≠ÔºåËøôÈáå‰ºöÊòæÁ§∫Âü∫‰∫éÊÇ®ÁöÑÂåªÁñóËÆ∞ÂΩïÁöÑÊô∫ËÉΩÂàÜÊûêÁªìÊûú„ÄÇ", isUser: false))
        }
    }
}

// MARK: - AI Chat Message Model
struct AIChatMessage: Identifiable {
    let id = UUID()
    let text: String
    let isUser: Bool
}

#Preview {
    RecordsView()
}

// MARK: - Record Detail View (ÈÄÇÈÖçÂô®)
struct RecordDetailView: View {
    let record: HealthRecord
    @EnvironmentObject var healthDataManager: HealthDataManager
    @Environment(\.dismiss) var dismiss
    @State private var isEditMode = false
    @State private var selectedReport: MedicalReport?
    @State private var showExcelViewer = false
    @State private var showImageViewer = false
    @State private var selectedImageData: Data?
    
    // ÁºñËæëÁä∂ÊÄÅÁöÑÂ≠óÊÆµ
    @State private var editedSymptoms: String = ""
    @State private var editedDiagnosis: String = ""
    @State private var editedTreatment: String = ""
    @State private var editedNotes: String = ""
    
    // ÂõæÁâáÂàÜÊûê
    @StateObject private var imageAnalyzer = ImageAnalysisManager.shared
    @State private var analyzingImageIndex: Int? = nil
    
    private var dateString: String {
        let formatter = DateFormatter()
        formatter.dateFormat = "yyyy-MM-dd"
        return formatter.string(from: record.date)
    }
    
    var body: some View {
        ZStack {
            Color.appBackgroundColor.ignoresSafeArea()
            
            VStack(spacing: 0) {
                // Ëá™ÂÆö‰πâÂØºËà™Ê†è
                HStack(spacing: 12) {
                    Button(action: { dismiss() }) {
                        Image(systemName: "chevron.left")
                            .font(.system(size: 18, weight: .medium))
                            .foregroundColor(.textPrimary)
                            .frame(width: 32, height: 32)
                    }
                    
                    VStack(alignment: .leading, spacing: 4) {
                        Text(record.hospitalName)
                            .font(.system(size: 20, weight: .semibold))
                            .foregroundColor(.textPrimary)
                        
                        HStack(spacing: 12) {
                            Text(record.department)
                                .font(.system(size: 13))
                                .foregroundColor(.textSecondary)
                            
                            Text(dateString)
                                .font(.system(size: 13))
                                .foregroundColor(.textSecondary)
                        }
                    }
                    
                    Spacer()
                    
                    // ÁºñËæë/‰øùÂ≠òÊåâÈíÆ
                    if isEditMode {
                        // ‰øùÂ≠òÊåâÈíÆ
                        Button(action: {
                            saveEdits()
                        }) {
                            HStack(spacing: 4) {
                                Image(systemName: "checkmark")
                                    .font(.system(size: 14))
                                Text("‰øùÂ≠ò")
                                    .font(.system(size: 13, weight: .medium))
                            }
                            .foregroundColor(.white)
                            .padding(.horizontal, 12)
                            .padding(.vertical, 6)
                            .background(Color.accentPrimary)
                            .cornerRadius(8)
                        }
                    } else {
                        // ÁºñËæëÊåâÈíÆ
                        Button(action: {
                            enterEditMode()
                        }) {
                            HStack(spacing: 4) {
                                Image(systemName: "square.and.pencil")
                                    .font(.system(size: 14))
                                Text("ÁºñËæë")
                                    .font(.system(size: 13, weight: .medium))
                            }
                            .foregroundColor(.accentPrimary)
                            .padding(.horizontal, 12)
                            .padding(.vertical, 6)
                            .background(Color.accentPrimary.opacity(0.1))
                            .cornerRadius(8)
                        }
                        
                        // ÂΩíÊ°£Áä∂ÊÄÅ
                        if !record.isArchived {
                            Button(action: {
                                archiveRecord()
                            }) {
                                HStack(spacing: 4) {
                                    Image(systemName: "archivebox")
                                        .font(.system(size: 14))
                                    Text("ÂΩíÊ°£")
                                        .font(.system(size: 13, weight: .medium))
                                }
                                .foregroundColor(.orange)
                                .padding(.horizontal, 12)
                                .padding(.vertical, 6)
                                .background(Color.orange.opacity(0.1))
                                .cornerRadius(8)
                            }
                        }
                    }
                }
                .padding(.horizontal, 20)
                .padding(.vertical, 16)
                .background(Color.cardBackgroundColor)
                .overlay(
                    Rectangle()
                        .fill(Color.dividerColor)
                        .frame(height: 1),
                    alignment: .bottom
                )
                
                ScrollView(showsIndicators: false) {
                    VStack(alignment: .leading, spacing: 24) {
                        // ÁóáÁä∂
                        RecordDetailSection(icon: "heart.text.square", title: "ÁóáÁä∂") {
                            if isEditMode {
                                TextEditor(text: $editedSymptoms)
                                    .font(.system(size: 15))
                                    .foregroundColor(.textPrimary)
                                    .frame(minHeight: 80)
                                    .padding(12)
                                    .background(Color.cardBackgroundColor)
                                    .cornerRadius(12)
                                    .overlay(
                                        RoundedRectangle(cornerRadius: 12)
                                            .stroke(Color.accentPrimary.opacity(0.3), lineWidth: 1)
                                    )
                            } else if !record.symptoms.isEmpty {
                                Text(record.symptoms)
                                    .font(.system(size: 15))
                                    .foregroundColor(.textPrimary)
                                    .padding(16)
                                    .frame(maxWidth: .infinity, alignment: .leading)
                                    .background(Color.secondaryBackgroundColor)
                                    .cornerRadius(12)
                            }
                        }
                        
                        // ËØäÊñ≠
                        RecordDetailSection(icon: "stethoscope", title: "ËØäÊñ≠") {
                            if isEditMode {
                                TextEditor(text: $editedDiagnosis)
                                    .font(.system(size: 15))
                                    .foregroundColor(.textPrimary)
                                    .frame(minHeight: 80)
                                    .padding(12)
                                    .background(Color.cardBackgroundColor)
                                    .cornerRadius(12)
                                    .overlay(
                                        RoundedRectangle(cornerRadius: 12)
                                            .stroke(Color.accentPrimary.opacity(0.3), lineWidth: 1)
                                    )
                            } else if let diagnosis = record.diagnosis, !diagnosis.isEmpty {
                                Text(diagnosis)
                                    .font(.system(size: 15))
                                    .foregroundColor(.textPrimary)
                                    .padding(16)
                                    .frame(maxWidth: .infinity, alignment: .leading)
                                    .background(Color.secondaryBackgroundColor)
                                    .cornerRadius(12)
                            }
                        }
                        
                        // Ê≤ªÁñóÊñπÊ°à
                        RecordDetailSection(icon: "cross.case", title: "Ê≤ªÁñóÊñπÊ°à") {
                            if isEditMode {
                                TextEditor(text: $editedTreatment)
                                    .font(.system(size: 15))
                                    .foregroundColor(.textPrimary)
                                    .frame(minHeight: 80)
                                    .padding(12)
                                    .background(Color.cardBackgroundColor)
                                    .cornerRadius(12)
                                    .overlay(
                                        RoundedRectangle(cornerRadius: 12)
                                            .stroke(Color.accentPrimary.opacity(0.3), lineWidth: 1)
                                    )
                            } else if let treatment = record.treatment, !treatment.isEmpty {
                                Text(treatment)
                                    .font(.system(size: 15))
                                    .foregroundColor(.textPrimary)
                                    .padding(16)
                                    .frame(maxWidth: .infinity, alignment: .leading)
                                    .background(Color.secondaryBackgroundColor)
                                    .cornerRadius(12)
                            }
                        }
                        
                        // ExcelÊä•ÂëäÔºàÊñ∞Â¢ûÔºâ
                        if !record.medicalReports.isEmpty {
                            let excelReports = record.medicalReports.filter { $0.fileType == "excel" }
                            if !excelReports.isEmpty {
                                RecordDetailSection(icon: "tablecells", title: "ExcelÊä•Âëä") {
                                    VStack(spacing: 12) {
                                        ForEach(excelReports) { reportRef in
                                            if let report = loadMedicalReport(id: reportRef.id) {
                                                ExcelReportCard(report: report) {
                                                    selectedReport = report
                                                    showExcelViewer = true
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        
                        // ÂΩïÈü≥ËÆ∞ÂΩïÔºàÂê´ËΩ¨ÊñáÊú¨Ôºâ
                        if !record.audioRecordings.isEmpty {
                            RecordDetailSection(icon: "mic", title: "ÂΩïÈü≥ËÆ∞ÂΩï") {
                                VStack(spacing: 12) {
                                    ForEach(record.audioRecordings) { audio in
                                        AudioRecordingCard(
                                            audio: audio,
                                            onPlayToggle: {
                                                // Êí≠Êîæ/ÊöÇÂÅúÈü≥È¢ë
                                            },
                                            onTranscribe: { transcription in
                                                // ‰øùÂ≠òËΩ¨ÂΩïÁªìÊûú
                                                saveTranscription(for: audio.id, text: transcription)
                                            }
                                        )
                                    }
                                }
                            }
                        }
                        
                        // ÈôÑ‰ª∂ÔºàÂõæÁâáÔºâ- Áº©Â∞èÊòæÁ§∫ + AIÂàÜÊûê
                        if !record.attachments.isEmpty {
                            RecordDetailSection(icon: "photo", title: "ÂõæÁâáÈôÑ‰ª∂") {
                                VStack(spacing: 12) {
                                    LazyVGrid(columns: [
                                        GridItem(.flexible(), spacing: 8),
                                        GridItem(.flexible(), spacing: 8),
                                        GridItem(.flexible(), spacing: 8)  // Êîπ‰∏∫3ÂàóÔºåÂõæÁâáÊõ¥Â∞è
                                    ], spacing: 8) {
                                        ForEach(Array(record.attachments.enumerated()), id: \.offset) { index, imageData in
                                            ZStack(alignment: .topTrailing) {
                                                Button(action: {
                                                    selectedImageData = imageData
                                                    showImageViewer = true
                                                }) {
                                                    if let image = UIImage(data: imageData) {
                                                        Image(uiImage: image)
                                                            .resizable()
                                                            .scaledToFill()
                                                            .frame(height: 100)  // ‰ªé150ÈôçÂà∞100
                                                            .clipped()
                                                            .cornerRadius(8)
                                                    } else {
                                                        ZStack {
                                                            Rectangle()
                                                                .fill(Color.secondaryBackgroundColor)
                                                                .frame(height: 100)
                                                                .cornerRadius(8)
                                                            
                                                            Image(systemName: "photo")
                                                                .font(.system(size: 24))
                                                                .foregroundColor(.textSecondary)
                                                        }
                                                    }
                                                }
                                                .buttonStyle(PlainButtonStyle())
                                                
                                                // AIÂàÜÊûêÊåâÈíÆ
                                                Button(action: {
                                                    analyzeImage(imageData, at: index)
                                                }) {
                                                    ZStack {
                                                        Circle()
                                                            .fill(Color.accentPrimary)
                                                            .frame(width: 28, height: 28)
                                                        
                                                        if analyzingImageIndex == index {
                                                            ProgressView()
                                                                .progressViewStyle(CircularProgressViewStyle(tint: .white))
                                                                .scaleEffect(0.6)
                                                        } else {
                                                            Image(systemName: "sparkles")
                                                                .font(.system(size: 12))
                                                                .foregroundColor(.white)
                                                        }
                                                    }
                                                }
                                                .buttonStyle(PlainButtonStyle())
                                                .padding(6)
                                            }
                                        }
                                    }
                                    
                                    // ÊèêÁ§∫
                                    if !record.attachments.isEmpty {
                                        HStack(spacing: 6) {
                                            Image(systemName: "info.circle")
                                                .font(.system(size: 12))
                                            Text("ÁÇπÂáªÂè≥‰∏äËßí‚ú®ÊåâÈíÆÔºåAIÂ∞ÜËá™Âä®ËØÜÂà´ÂåªÂò±ÊàñËØäÊñ≠‰π¶")
                                                .font(.system(size: 11))
                                        }
                                        .foregroundColor(.textTertiary)
                                        .padding(.top, 4)
                                    }
                                }
                            }
                        }
                        
                        // Â§áÊ≥®
                        RecordDetailSection(icon: "note.text", title: "Â§áÊ≥®") {
                            if isEditMode {
                                TextEditor(text: $editedNotes)
                                    .font(.system(size: 15))
                                    .foregroundColor(.textPrimary)
                                    .frame(minHeight: 80)
                                    .padding(12)
                                    .background(Color.cardBackgroundColor)
                                    .cornerRadius(12)
                                    .overlay(
                                        RoundedRectangle(cornerRadius: 12)
                                            .stroke(Color.accentPrimary.opacity(0.3), lineWidth: 1)
                                    )
                            } else if let notes = record.notes, !notes.isEmpty {
                                Text(notes)
                                    .font(.system(size: 15))
                                    .foregroundColor(.textPrimary)
                                    .padding(16)
                                    .frame(maxWidth: .infinity, alignment: .leading)
                                    .background(Color.secondaryBackgroundColor)
                                    .cornerRadius(12)
                            }
                        }
                        
                        // AIÊä•ÂëäÂàÜÊûêÔºàÂ∫ïÈÉ®Ôºâ
                        if hasAnyData {
                            RecordDetailSection(icon: "sparkles", title: "AIÊô∫ËÉΩÂàÜÊûê") {
                                AIReportAnalysisView(
                                    reportData: buildReportContext(),
                                    reportType: "Â∞±ËØäËÆ∞ÂΩï",
                                    attachmentsHash: calculateAttachmentsHash()
                                )
                                .environmentObject(healthDataManager)
                            }
                        }
                    }
                    .padding(20)
                }
            }
        }
        .navigationBarHidden(true)
        .sheet(isPresented: $showExcelViewer) {
            if let report = selectedReport {
                ExcelViewerView(report: report)
            }
        }
        .sheet(isPresented: $showImageViewer) {
            if let imageData = selectedImageData, let image = UIImage(data: imageData) {
                ImageDetailView(image: image)
            }
        }
    }
    
    private var hasAnyData: Bool {
        return !record.medicalReports.isEmpty || !record.audioRecordings.isEmpty || !record.attachments.isEmpty
    }
    
    private func buildReportContext() -> String {
        var context = ""
        context += "ÂåªÈô¢Ôºö\(record.hospitalName)\n"
        context += "ÁßëÂÆ§Ôºö\(record.department)\n"
        context += "Â∞±ËØäÊó•ÊúüÔºö\(dateString)\n\n"
        
        // Ëá™Âä®ÊèêÂèñÁÖßÁâá‰∏≠ÁöÑÊñáÂ≠óÔºàOCRÔºâ
        if !record.attachments.isEmpty {
            context += "„ÄêÊä•ÂëäÁÖßÁâáÂÜÖÂÆπ„Äë\n"
            for (index, imageData) in record.attachments.enumerated() {
                let ocrText = extractTextFromImage(imageData)
                if !ocrText.isEmpty && ocrText != "ÂõæÁâá‰∏≠Êú™ËØÜÂà´Âà∞ÊñáÂ≠óÔºåËØ∑Á°Æ‰øùÁÖßÁâáÊ∏ÖÊô∞" {
                    context += "Êä•Âëä\(index + 1)Ôºö\n\(ocrText)\n\n"
                }
            }
        }
        
        if !record.symptoms.isEmpty && record.symptoms != "ÂæÖË°•ÂÖÖ" && !record.symptoms.contains("Êä•ÂëäÁÖßÁâá") {
            context += "ÁóáÁä∂Ôºö\(record.symptoms)\n\n"
        }
        
        if let diagnosis = record.diagnosis, !diagnosis.isEmpty {
            context += "ËØäÊñ≠Ôºö\(diagnosis)\n\n"
        }
        
        if let treatment = record.treatment, !treatment.isEmpty {
            context += "Ê≤ªÁñóÊñπÊ°àÔºö\(treatment)\n\n"
        }
        
        // Ê∑ªÂä†ËΩ¨ÂΩïÊñáÊú¨
        for audio in record.audioRecordings {
            if let transcription = audio.transcribedText, audio.isTranscribed {
                context += "ÂΩïÈü≥ËΩ¨ÂΩïÔºö\(transcription)\n\n"
            }
        }
        
        if let notes = record.notes, !notes.isEmpty {
            context += "Â§áÊ≥®Ôºö\(notes)\n"
        }
        
        return context
    }
    
    // ËÆ°ÁÆóÈôÑ‰ª∂ÁöÑÂìàÂ∏åÂÄºÔºàÁî®‰∫éÂà§Êñ≠ÈôÑ‰ª∂ÊòØÂê¶ÊúâÂèòÂåñÔºâ
    private func calculateAttachmentsHash() -> String {
        // Âü∫‰∫éÈôÑ‰ª∂ÁöÑÊï∞ÈáèÂíåÊØè‰∏™ÈôÑ‰ª∂ÁöÑÂ§ßÂ∞èÊù•ÁîüÊàêhash
        var hashString = "\(record.attachments.count)"
        for imageData in record.attachments {
            hashString += "_\(imageData.count)"
        }
        return String(hashString.hashValue)
    }
    
    // ‰ªéÂõæÁâá‰∏≠ÊèêÂèñÊñáÂ≠óÔºàOCRÔºâ
    private func extractTextFromImage(_ imageData: Data) -> String {
        guard let image = UIImage(data: imageData),
              let cgImage = image.cgImage else {
            return ""
        }
        
        var extractedText = ""
        let semaphore = DispatchSemaphore(value: 0)
        
        if #available(iOS 13.0, *) {
            let request = VNRecognizeTextRequest { request, error in
                guard error == nil,
                      let observations = request.results as? [VNRecognizedTextObservation] else {
                    semaphore.signal()
                    return
                }
                
                let recognizedStrings = observations.compactMap { observation in
                    observation.topCandidates(1).first?.string
                }
                
                extractedText = recognizedStrings.joined(separator: "\n")
                semaphore.signal()
            }
            
            request.recognitionLanguages = ["zh-Hans", "zh-Hant", "en-US"]
            request.recognitionLevel = .accurate
            request.usesLanguageCorrection = true
            
            let handler = VNImageRequestHandler(cgImage: cgImage, options: [:])
            
            DispatchQueue.global(qos: .userInitiated).async {
                do {
                    try handler.perform([request])
                } catch {
                    print("‚ùå OCRÂ§ÑÁêÜÂ§±Ë¥•: \(error.localizedDescription)")
                    semaphore.signal()
                }
            }
            
            // Á≠âÂæÖOCRÂÆåÊàêÔºàÊúÄÂ§ö3ÁßíÔºâ
            _ = semaphore.wait(timeout: .now() + 3)
        }
        
        if extractedText.isEmpty {
            print("‚ö†Ô∏è ÂõæÁâá‰∏≠Êú™ËØÜÂà´Âà∞ÊñáÂ≠ó")
        } else {
            print("‚úÖ OCRËØÜÂà´ÊàêÂäüÔºåÊèêÂèñ‰∫ÜÊñáÂ≠óÔºö\(extractedText.prefix(100))...")
        }
        
        return extractedText
    }
    
    private func loadMedicalReport(id: UUID) -> MedicalReport? {
        // ‰ªéMedicalReportManagerÂä†ËΩΩÊä•Âëä
        // ËøôÈúÄË¶ÅÂú®HealthDataManager‰∏≠Ê∑ªÂä†ÂØπMedicalReportManagerÁöÑÂºïÁî®
        return nil // ‰∏¥Êó∂ËøîÂõûnil,ÈúÄË¶ÅÂÆûÁé∞
    }
    
    // ËøõÂÖ•ÁºñËæëÊ®°Âºè
    private func enterEditMode() {
        editedSymptoms = record.symptoms
        editedDiagnosis = record.diagnosis ?? ""
        editedTreatment = record.treatment ?? ""
        editedNotes = record.notes ?? ""
        
        withAnimation {
            isEditMode = true
        }
    }
    
    // ‰øùÂ≠òÁºñËæë
    private func saveEdits() {
        var updatedRecord = record
        updatedRecord.symptoms = editedSymptoms
        updatedRecord.diagnosis = editedDiagnosis.isEmpty ? nil : editedDiagnosis
        updatedRecord.treatment = editedTreatment.isEmpty ? nil : editedTreatment
        updatedRecord.notes = editedNotes.isEmpty ? nil : editedNotes
        
        healthDataManager.updateHealthRecord(updatedRecord)
        
        withAnimation {
            isEditMode = false
        }
        
        print("‚úÖ ‰øùÂ≠ò‰∫ÜÁºñËæëÂÜÖÂÆπ")
    }
    
    private func archiveRecord() {
        var updatedRecord = record
        updatedRecord.isArchived = true
        healthDataManager.updateHealthRecord(updatedRecord)
        dismiss()
    }
    
    private func formatDuration(_ duration: TimeInterval) -> String {
        let minutes = Int(duration) / 60
        let seconds = Int(duration) % 60
        return String(format: "%d:%02d", minutes, seconds)
    }
    
    private func formatDate(_ date: Date) -> String {
        let formatter = DateFormatter()
        formatter.dateFormat = "yyyy-MM-dd"
        return formatter.string(from: date)
    }
    
    // ÂàÜÊûêÂõæÁâá
    private func analyzeImage(_ imageData: Data, at index: Int) {
        analyzingImageIndex = index
        
        imageAnalyzer.analyzeImage(
            imageData: imageData,
            onUpdate: { partialResult in
                print("üìÑ AIÂàÜÊûê‰∏≠: \(partialResult)")
            },
            onComplete: { result in
                analyzingImageIndex = nil
                
                // Ê†πÊçÆÂàÜÊûêÁªìÊûúËá™Âä®Â°´ÂÖÖ
                var updatedRecord = record
                
                switch result.documentType {
                case .prescription:
                    // ÂåªÂò±/Â§ÑÊñπ - ‰øùÂ≠òÂà∞Ê≤ªÁñóÊñπÊ°à
                    if let treatmentPlan = result.treatmentPlan {
                        let currentTreatment = updatedRecord.treatment ?? ""
                        let newTreatment = currentTreatment.isEmpty ? treatmentPlan : "\(currentTreatment)\n\n\(treatmentPlan)"
                        updatedRecord.treatment = newTreatment
                        
                        // Â¶ÇÊûúÂú®ÁºñËæëÊ®°ÂºèÔºåÂêåÊ≠•Êõ¥Êñ∞ÁºñËæëÂ≠óÊÆµ
                        if isEditMode {
                            editedTreatment = newTreatment
                        }
                        
                        print("‚úÖ ËØÜÂà´‰∏∫ÂåªÂò±ÔºåÊ≤ªÁñóÊñπÊ°àÂ∑≤‰øùÂ≠ò")
                    }
                    
                case .diagnosis:
                    // ËØäÊñ≠‰π¶ - ‰øùÂ≠òÂà∞ËØäÊñ≠
                    if let diagnosis = result.diagnosis {
                        let currentDiagnosis = updatedRecord.diagnosis ?? ""
                        let newDiagnosis = currentDiagnosis.isEmpty ? diagnosis : "\(currentDiagnosis)\n\n\(diagnosis)"
                        updatedRecord.diagnosis = newDiagnosis
                        
                        // Â¶ÇÊûúÂú®ÁºñËæëÊ®°ÂºèÔºåÂêåÊ≠•Êõ¥Êñ∞ÁºñËæëÂ≠óÊÆµ
                        if isEditMode {
                            editedDiagnosis = newDiagnosis
                        }
                        
                        print("‚úÖ ËØÜÂà´‰∏∫ËØäÊñ≠‰π¶ÔºåËØäÊñ≠Â∑≤‰øùÂ≠ò")
                    }
                    
                case .other:
                    print("‚ÑπÔ∏è Êú™ËØÜÂà´‰∏∫ÂåªÂò±ÊàñËØäÊñ≠‰π¶")
                }
                
                // ‰øùÂ≠òÊõ¥Êñ∞
                healthDataManager.updateHealthRecord(updatedRecord)
            }
        )
    }
    
    // ‰øùÂ≠òËΩ¨ÂΩïÁªìÊûú
    private func saveTranscription(for audioId: UUID, text: String) {
        var updatedRecord = record
        
        // ÊâæÂà∞ÂØπÂ∫îÁöÑÂΩïÈü≥ËÆ∞ÂΩïÂπ∂Êõ¥Êñ∞
        if let index = updatedRecord.audioRecordings.firstIndex(where: { $0.id == audioId }) {
            updatedRecord.audioRecordings[index].transcribedText = text
            updatedRecord.audioRecordings[index].isTranscribed = true
            
            print("‚úÖ ËΩ¨ÂΩïÊñáÊú¨Â∑≤‰øùÂ≠òÂà∞ÂΩïÈü≥ËÆ∞ÂΩï")
            print("üìù ËΩ¨ÂΩïÂÜÖÂÆπ: \(text)")
            
            // ‰øùÂ≠òÊõ¥Êñ∞ÁöÑËÆ∞ÂΩï
            healthDataManager.updateHealthRecord(updatedRecord)
        }
    }
}

// MARK: - Excel Report Card
struct ExcelReportCard: View {
    let report: MedicalReport
    let onTap: () -> Void
    
    var body: some View {
        Button(action: onTap) {
            HStack(spacing: 12) {
                // ExcelÂõæÊ†á
                ZStack {
                    RoundedRectangle(cornerRadius: 10, style: .continuous)
                        .fill(Color.green.opacity(0.15))
                        .frame(width: 48, height: 48)
                    
                    Image(systemName: "tablecells.fill")
                        .font(.system(size: 24))
                        .foregroundColor(.green)
                }
                
                VStack(alignment: .leading, spacing: 4) {
                    Text(report.title)
                        .font(.system(size: 15, weight: .medium))
                        .foregroundColor(.textPrimary)
                    
                    HStack(spacing: 8) {
                        Text(report.reportType.displayName)
                            .font(.system(size: 12))
                            .foregroundColor(.textSecondary)
                        
                        if let fileName = report.excelFileName {
                            Text("‚Ä¢")
                                .foregroundColor(.textTertiary)
                            Text(fileName)
                                .font(.system(size: 12))
                                .foregroundColor(.textSecondary)
                                .lineLimit(1)
                        }
                    }
                }
                
                Spacer()
                
                Image(systemName: "chevron.right")
                    .font(.system(size: 14))
                    .foregroundColor(.textTertiary)
            }
            .padding(12)
            .background(
                RoundedRectangle(cornerRadius: 12, style: .continuous)
                    .fill(Color.secondaryBackgroundColor)
            )
        }
        .buttonStyle(PlainButtonStyle())
    }
}

// MARK: - Audio Recording Card with Transcription
struct AudioRecordingCard: View {
    let audio: HealthRecord.AudioRecording
    let onPlayToggle: () -> Void
    let onTranscribe: ((String) -> Void)? // ËΩ¨ÂΩïÂÆåÊàêÂõûË∞É
    
    @StateObject private var audioPlayer = AudioPlayerManager.shared
    @StateObject private var speechRecognizer = SpeechRecognitionManager.shared
    @State private var showTranscription = false
    @State private var isTranscribing = false
    
    private var durationString: String {
        let minutes = Int(audio.duration) / 60
        let seconds = Int(audio.duration) % 60
        return String(format: "%d:%02d", minutes, seconds)
    }
    
    private var dateString: String {
        let formatter = DateFormatter()
        formatter.dateFormat = "yyyy-MM-dd HH:mm"
        return formatter.string(from: audio.date)
    }
    
    var body: some View {
        VStack(alignment: .leading, spacing: 12) {
            // Êí≠ÊîæÂô®ÈÉ®ÂàÜ
            HStack(spacing: 12) {
                // Êí≠ÊîæÊåâÈíÆ
                Button(action: {
                    audioPlayer.play(audioData: audio.audioData, audioId: audio.id)
                }) {
                    Image(systemName: audioPlayer.isPlaying ? "pause.fill" : "play.fill")
                        .font(.system(size: 20))
                        .foregroundColor(.white)
                        .frame(width: 48, height: 48)
                        .background(Color.textPrimary)
                        .clipShape(Circle())
                }
                .buttonStyle(PlainButtonStyle())
                
                VStack(alignment: .leading, spacing: 4) {
                    Text(audio.title ?? "ÂΩïÈü≥ËÆ∞ÂΩï")
                        .font(.system(size: 15, weight: .medium))
                        .foregroundColor(.textPrimary)
                    
                    HStack(spacing: 8) {
                        Text(durationString)
                            .font(.system(size: 12))
                            .foregroundColor(.textSecondary)
                        
                        Text("‚Ä¢")
                            .foregroundColor(.textTertiary)
                        
                        Text(dateString)
                            .font(.system(size: 12))
                            .foregroundColor(.textSecondary)
                    }
                }
                
                Spacer()
                
                // ËΩ¨ÊñáÊú¨ÊåâÈíÆ/Ê†áÁ≠æ
                if isTranscribing {
                    // ËΩ¨ÂΩï‰∏≠
                    HStack(spacing: 6) {
                        ProgressView()
                            .scaleEffect(0.7)
                        Text("ËΩ¨ÂΩï‰∏≠...")
                            .font(.system(size: 11, weight: .medium))
                    }
                    .foregroundColor(.orange)
                    .padding(.horizontal, 10)
                    .padding(.vertical, 6)
                    .background(Color.orange.opacity(0.1))
                    .cornerRadius(6)
                } else if audio.isTranscribed {
                    // Â∑≤ËΩ¨ÂΩï - Êü•ÁúãÊñáÊú¨
                    Button(action: {
                        showTranscription.toggle()
                    }) {
                        HStack(spacing: 4) {
                            Image(systemName: showTranscription ? "chevron.up" : "text.bubble.fill")
                                .font(.system(size: 12))
                            Text(showTranscription ? "Êî∂Ëµ∑" : "Êü•ÁúãÊñáÊú¨")
                                .font(.system(size: 11, weight: .medium))
                        }
                        .foregroundColor(.blue)
                        .padding(.horizontal, 8)
                        .padding(.vertical, 4)
                        .background(Color.blue.opacity(0.1))
                        .cornerRadius(6)
                    }
                    .buttonStyle(PlainButtonStyle())
                } else {
                    // Êú™ËΩ¨ÂΩï - ËΩ¨ÊñáÂ≠óÊåâÈíÆ
                    Button(action: {
                        startTranscription()
                    }) {
                        HStack(spacing: 4) {
                            Image(systemName: "waveform.and.mic")
                                .font(.system(size: 12))
                            Text("ËΩ¨ÊñáÂ≠ó")
                                .font(.system(size: 11, weight: .medium))
                        }
                        .foregroundColor(.accentPrimary)
                        .padding(.horizontal, 8)
                        .padding(.vertical, 4)
                        .background(Color.accentPrimary.opacity(0.1))
                        .cornerRadius(6)
                    }
                    .buttonStyle(PlainButtonStyle())
                }
            }
            
            // ËΩ¨ÊñáÊú¨ÂÜÖÂÆπÔºàÂèØÂ±ïÂºÄÔºâ
            if audio.isTranscribed && showTranscription {
                VStack(alignment: .leading, spacing: 8) {
                    Divider()
                    
                    HStack {
                        Image(systemName: "text.alignleft")
                            .font(.system(size: 14))
                            .foregroundColor(.textSecondary)
                        
                        Text("ËΩ¨ÂΩïÊñáÊú¨")
                            .font(.system(size: 13, weight: .semibold))
                            .foregroundColor(.textSecondary)
                        
                        Spacer()
                    }
                    
                    if let transcription = audio.transcribedText {
                        Text(transcription)
                            .font(.system(size: 14))
                            .foregroundColor(.textPrimary)
                            .lineSpacing(4)
                            .textSelection(.enabled)
                    } else {
                        Text("ÊöÇÊó†ËΩ¨ÂΩïÂÜÖÂÆπ")
                            .font(.system(size: 14))
                            .foregroundColor(.textTertiary)
                            .italic()
                    }
                }
                .padding(.top, 4)
            }
        }
        .padding(16)
        .background(
            RoundedRectangle(cornerRadius: 16, style: .continuous)
                .fill(Color.secondaryBackgroundColor)
        )
    }
    
    // MARK: - ËΩ¨ÂΩïÂäüËÉΩ
    
    private func startTranscription() {
        guard !audio.audioData.isEmpty else {
            print("‚ùå Èü≥È¢ëÊï∞ÊçÆ‰∏∫Á©∫ÔºåÊó†Ê≥ïËΩ¨ÂΩï")
            return
        }
        
        isTranscribing = true
        print("üé§ ÂºÄÂßãËΩ¨ÂΩïÈü≥È¢ëÔºåÂ§ßÂ∞è: \(audio.audioData.count) Â≠óËäÇ")
        
        speechRecognizer.transcribeAudio(audioData: audio.audioData) { result in
            DispatchQueue.main.async {
                self.isTranscribing = false
                
                switch result {
                case .success(let transcription):
                    print("‚úÖ ËΩ¨ÂΩïÊàêÂäü: \(transcription)")
                    // Ë∞ÉÁî®ÂõûË∞É‰øùÂ≠òËΩ¨ÂΩïÁªìÊûú
                    self.onTranscribe?(transcription)
                    // Ëá™Âä®Â±ïÂºÄÊòæÁ§∫ÊñáÊú¨
                    self.showTranscription = true
                    
                case .failure(let error):
                    print("‚ùå ËΩ¨ÂΩïÂ§±Ë¥•: \(error.localizedDescription)")
                    // ÂèØ‰ª•ÊòæÁ§∫ÈîôËØØÊèêÁ§∫
                }
            }
        }
    }
}

// MARK: - Image Detail Viewer
struct ImageDetailView: View {
    let image: UIImage
    @Environment(\.dismiss) var dismiss
    @State private var scale: CGFloat = 1.0
    @State private var lastScale: CGFloat = 1.0
    
    var body: some View {
        NavigationView {
            ZStack {
                Color.black.ignoresSafeArea()
                
                Image(uiImage: image)
                    .resizable()
                    .scaledToFit()
                    .scaleEffect(scale)
                    .gesture(
                        MagnificationGesture()
                            .onChanged { value in
                                scale = lastScale * value
                            }
                            .onEnded { _ in
                                lastScale = scale
                                if scale < 1 {
                                    withAnimation {
                                        scale = 1
                                        lastScale = 1
                                    }
                                } else if scale > 5 {
                                    withAnimation {
                                        scale = 5
                                        lastScale = 5
                                    }
                                }
                            }
                    )
            }
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarLeading) {
                    Button(action: {
                        dismiss()
                    }) {
                        Image(systemName: "xmark")
                            .font(.system(size: 16, weight: .semibold))
                            .foregroundColor(.white)
                    }
                }
                
                ToolbarItem(placement: .navigationBarTrailing) {
                    Menu {
                        Button(action: {
                            saveImageToPhotos(image)
                        }) {
                            Label("‰øùÂ≠òÂà∞Áõ∏ÂÜå", systemImage: "square.and.arrow.down")
                        }
                        
                        Button(action: {
                            shareImage(image)
                        }) {
                            Label("ÂàÜ‰∫´", systemImage: "square.and.arrow.up")
                        }
                    } label: {
                        Image(systemName: "ellipsis")
                            .font(.system(size: 16, weight: .semibold))
                            .foregroundColor(.white)
                    }
                }
            }
        }
    }
    
    private func saveImageToPhotos(_ image: UIImage) {
        UIImageWriteToSavedPhotosAlbum(image, nil, nil, nil)
    }
    
    private func shareImage(_ image: UIImage) {
        let activityVC = UIActivityViewController(activityItems: [image], applicationActivities: nil)
        
        if let windowScene = UIApplication.shared.connectedScenes.first as? UIWindowScene,
           let window = windowScene.windows.first,
           let rootVC = window.rootViewController {
            rootVC.present(activityVC, animated: true)
        }
    }
}

// MARK: - Swipeable Record Card
struct SwipeableRecordCard: View {
    let record: HealthRecord
    @EnvironmentObject var healthDataManager: HealthDataManager
    @State private var offset: CGFloat = 0
    @State private var showingDeleteConfirm = false
    @State private var isDragging = false
    
    private let deleteButtonWidth: CGFloat = 80
    
    var body: some View {
        ZStack(alignment: .trailing) {
            // Âà†Èô§ÊåâÈíÆÔºàËÉåÊôØÔºâ
            HStack(spacing: 0) {
                Spacer()
                Button(action: {
                    showingDeleteConfirm = true
                }) {
                    VStack(spacing: 6) {
                        Image(systemName: "trash.fill")
                            .font(.system(size: 18, weight: .semibold))
                        Text("Âà†Èô§")
                            .font(.system(size: 11, weight: .medium))
                    }
                    .foregroundColor(.white)
                    .frame(width: deleteButtonWidth)
                    .frame(maxHeight: .infinity)
                }
                .buttonStyle(PlainButtonStyle())
            }
            .frame(maxHeight: .infinity)
            .background(Color.red)
            .cornerRadius(20)
            
            // Âç°ÁâáÂÜÖÂÆπ
            RecordCardView(record: record)
                .background(Color.appBackgroundColor)
                .offset(x: offset)
                .highPriorityGesture(
                    DragGesture(minimumDistance: 15)
                        .onChanged { value in
                            isDragging = true
                            let translation = value.translation.width
                            
                            // Âè™ÂÖÅËÆ∏ÂêëÂ∑¶ÊªëÂä®ÊòæÁ§∫Âà†Èô§ÊåâÈíÆ
                            if translation < 0 {
                                // ÂêëÂ∑¶ÊªëÂä®
                                offset = max(translation, -deleteButtonWidth)
                            } else if offset < 0 {
                                // Â∑≤ÁªèÊâìÂºÄÔºåÂÖÅËÆ∏ÂêëÂè≥ÊªëÂä®ÂÖ≥Èó≠
                                offset = min(0, offset + translation)
                            }
                        }
                        .onEnded { value in
                            isDragging = false
                            let velocity = value.predictedEndTranslation.width - value.translation.width
                            
                            withAnimation(.spring(response: 0.35, dampingFraction: 0.75)) {
                                // Ê†πÊçÆÊªëÂä®Ë∑ùÁ¶ªÂíåÈÄüÂ∫¶ÂÜ≥ÂÆöÊòØÂê¶ÊâìÂºÄ
                                if value.translation.width < -40 || velocity < -100 {
                                    // ÊªëÂä®Ë∂ÖËøá40ÁÇπÊàñÂø´ÈÄüÂêëÂ∑¶ÊªëÔºåÊòæÁ§∫Âà†Èô§ÊåâÈíÆ
                                    offset = -deleteButtonWidth
                                } else {
                                    // Âê¶ÂàôÂõûÂºπ
                                    offset = 0
                                }
                            }
                        }
                )
        }
        .clipped()
        .alert("Âà†Èô§ËÆ∞ÂΩï", isPresented: $showingDeleteConfirm) {
            Button("ÂèñÊ∂à", role: .cancel) {
                withAnimation(.spring(response: 0.35, dampingFraction: 0.75)) {
                    offset = 0
                }
            }
            Button("Âà†Èô§", role: .destructive) {
                deleteRecord()
            }
        } message: {
            Text("Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Â∞±ËØäËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ")
        }
    }
    
    private func deleteRecord() {
        withAnimation {
            healthDataManager.deleteHealthRecord(record)
        }
    }
}
